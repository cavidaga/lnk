<!DOCTYPE html>
<html lang="az" class="no-js">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />

  <title>LNK.az Admin Paneli</title>
  <meta name="description" content="LNK.az Admin Paneli - Ä°stifadÉ™Ã§i idarÉ™etmÉ™si vÉ™ sistem konfiqurasiyasÄ±" />
  <meta name="theme-color" content="#0c0d12">
  <meta name="color-scheme" content="light dark" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/static/favicon.ico">
  <link rel="icon" href="/static/favicon-light.svg" media="(prefers-color-scheme: light)">
  <link rel="icon" href="/static/favicon-dark.svg"  media="(prefers-color-scheme: dark)">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">

  <link rel="stylesheet" href="/static/styles.css">
  
  <style>
    /* Admin-specific styles */
    .admin-header {
      text-align: center;
      margin-bottom: 2rem;
      padding: 2rem;
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(220, 53, 69, 0.3);
    }
    
    .admin-header h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .admin-header p {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .admin-section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }

    .admin-section h2 {
      color: #1f2937;
      margin-bottom: 1rem;
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .user-info {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      text-align: center;
    }

    .user-info h4 {
      color: #6b7280;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .user-info p {
      color: #1f2937;
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }

    .user-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      transition: all 0.2s ease;
    }

    .user-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    .user-card h4 {
      color: #1f2937;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .user-card p {
      color: #6b7280;
      margin-bottom: 0.25rem;
      font-size: 0.875rem;
    }

    .user-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    .btn-warning:hover {
      background: #d97706;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
    }

    .plan-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
    }

    .plan-free { background: #f3f4f6; color: #374151; }
    .plan-basic { background: #dbeafe; color: #1e40af; }
    .plan-pro { background: #fef3c7; color: #d97706; }
    .plan-enterprise { background: #e0e7ff; color: #5b21b6; }

    .error {
      background: #fef2f2;
      color: #dc2626;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #fecaca;
      margin-bottom: 1rem;
    }

    .success {
      background: #f0fdf4;
      color: #16a34a;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #bbf7d0;
      margin-bottom: 1rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #374151;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 1rem;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .hidden {
      display: none !important;
    }

    .stats-divider {
      border-top: 2px solid #e5e7eb;
      margin: 1.5rem 0;
      position: relative;
    }

    .stats-divider::before {
      content: "Developer StatistikalarÄ±";
      position: absolute;
      top: -0.75rem;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 0 1rem;
      color: #6b7280;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .admin-section {
      margin-bottom: 2rem;
    }
    
    .admin-section h2 {
      background: var(--panel);
      padding: 1.5rem;
      margin: 0 0 0 0;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      font-size: 1.5rem;
      border-radius: 12px 12px 0 0;
    }
    
    .admin-content {
      padding: 1.5rem;
      background: var(--card);
      border-radius: 0 0 12px 12px;
      border: 1px solid var(--border);
      border-top: none;
    }
    
    .user-info {
      background: var(--panel);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }
    
    .user-info h3 {
      margin: 0 0 0.5rem 0;
      color: var(--text);
    }
    
    .user-info p {
      margin: 0.25rem 0;
      color: var(--muted);
    }
    
    .hidden {
      display: none;
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    
    .status-online {
      background-color: #28a745;
    }
    
    .status-offline {
      background-color: #dc3545;
    }
    
    .users-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .user-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.2s ease;
    }
    
    .user-card:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .user-card h4 {
      margin: 0 0 0.5rem 0;
      color: var(--text);
    }
    
    .user-card p {
      margin: 0.25rem 0;
      color: var(--muted);
      font-size: 0.9rem;
    }
    
    .user-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
    }
    
    .plan-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .plan-free {
      background: #e9ecef;
      color: #495057;
    }
    
    .plan-pro {
      background: #d4edda;
      color: #155724;
    }
    
    .plan-enterprise {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--muted);
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    
    .success {
      background: #d4edda;
      color: #155724;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="site-header"></div>
    <main id="main" role="main">
      <div class="admin-panel">
        <div class="admin-header">
          <h1>ğŸ›¡ï¸ LNK.az Admin Paneli</h1>
          <p>Ä°stifadÉ™Ã§i idarÉ™etmÉ™si vÉ™ sistem konfiqurasiyasÄ±</p>
        </div>

        <!-- Admin Status -->
        <div class="admin-section">
          <h2>Admin Statusu</h2>
          <div class="admin-content">
            <div id="admin-status">
              <div class="status-indicator status-offline"></div>
              <span>Admin hesabÄ±na daxil olunmayÄ±b</span>
            </div>
            <div id="admin-info" class="user-info hidden">
              <h3 id="admin-name">Admin</h3>
              <p id="admin-email">admin@example.com</p>
              <p>Rol: Sistem Administratoru</p>
            </div>
            <div style="margin-top: 1rem;">
              <button id="logout-btn" class="btn btn-danger hidden">Ã‡Ä±xÄ±ÅŸ</button>
            </div>
          </div>
        </div>

        <!-- Login Form -->
        <div class="admin-section" id="login-section">
          <h2>Admin Daxil Ol</h2>
          <div class="admin-content">
            <form id="login-form">
              <div class="form-group">
                <label for="login-email">E-poÃ§t</label>
                <input type="email" id="login-email" required>
              </div>
              <div class="form-group">
                <label for="login-password">ÅifrÉ™</label>
                <input type="password" id="login-password" required>
              </div>
              <button type="submit" class="btn btn-primary">Daxil ol</button>
            </form>
          </div>
        </div>

        <!-- User Management -->
        <div class="admin-section" id="user-management-section">
          <h2>ğŸ‘¥ Ä°stifadÉ™Ã§i Ä°darÉ™etmÉ™si</h2>
          <div class="admin-content">
            <div class="form-row">
              <div class="form-group">
                <label for="search-users">Ä°stifadÉ™Ã§i axtar</label>
                <input type="text" id="search-users" placeholder="E-poÃ§t, istifadÉ™Ã§i adÄ± vÉ™ ya ID ilÉ™ axtar...">
              </div>
              <div class="form-group">
                <label for="filter-plan">Plan filtri</label>
                <select id="filter-plan">
                  <option value="">BÃ¼tÃ¼n planlar</option>
                  <option value="free">Pulsuz</option>
                  <option value="basic">Æsas</option>
                  <option value="pro">Pro</option>
                  <option value="enterprise">Enterprise</option>
                </select>
              </div>
            </div>
            
            <div class="button-group" style="margin: 1rem 0;">
              <button id="load-users-btn" class="btn btn-primary">ğŸ“¥ Ä°stifadÉ™Ã§ilÉ™ri yÃ¼klÉ™</button>
              <button id="create-user-btn" class="btn btn-success">â• Yeni istifadÉ™Ã§i yarat</button>
            </div>

            <div id="users-container">
              <div class="loading">Ä°stifadÉ™Ã§ilÉ™r yÃ¼klÉ™nir...</div>
            </div>
          </div>
        </div>

        <!-- Create User Form -->
        <div class="admin-section" id="create-user-section">
          <h2>â• Yeni Ä°stifadÉ™Ã§i Yarat</h2>
          <div class="admin-content">
            <form id="create-user-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="new-user-email">E-poÃ§t</label>
                  <input type="email" id="new-user-email" required>
                </div>
                <div class="form-group">
                  <label for="new-user-password">ÅifrÉ™</label>
                  <input type="password" id="new-user-password" minlength="8" required>
                </div>
              </div>
              <div class="form-group">
                <label for="new-user-plan">Plan</label>
                <select id="new-user-plan">
                  <option value="free">Pulsuz</option>
                  <option value="basic">Æsas</option>
                  <option value="pro">Pro</option>
                  <option value="enterprise">Enterprise</option>
                </select>
              </div>
              <div class="button-group">
                <button type="submit" class="btn btn-success">âœ¨ Ä°stifadÉ™Ã§i yarat</button>
                <button type="button" id="cancel-create-user" class="btn btn-secondary">âŒ LÉ™ÄŸv et</button>
              </div>
            </form>
          </div>
        </div>

        <!-- System Statistics -->
        <div class="admin-section" id="stats-section">
          <h2>ğŸ“Š Sistem StatistikalarÄ±</h2>
          <div class="admin-content">
            <div class="form-row">
              <div class="user-info">
                <h4>ğŸ‘¥ Ãœmumi Ä°stifadÉ™Ã§ilÉ™r</h4>
                <p id="total-users">-</p>
              </div>
              <div class="user-info">
                <h4>ğŸ†“ Pulsuz Plan</h4>
                <p id="free-users">-</p>
              </div>
              <div class="user-info">
                <h4>â­ Æsas Plan</h4>
                <p id="basic-users">-</p>
              </div>
              <div class="user-info">
                <h4>ğŸ’ Pro Plan</h4>
                <p id="pro-users">-</p>
              </div>
              <div class="user-info">
                <h4>ğŸ¢ Enterprise Plan</h4>
                <p id="enterprise-users">-</p>
              </div>
            </div>
            <div class="stats-divider"></div>
            <div class="form-row" id="dev-stats">
              <div class="user-info">
                <h4>ğŸ”§ DeveloperlÉ™r</h4>
                <p id="total-developers">-</p>
              </div>
              <div class="user-info">
                <h4>âœ… TÉ™sdiqlÉ™nmiÅŸ</h4>
                <p id="approved-developers">-</p>
              </div>
              <div class="user-info">
                <h4>â³ GÃ¶zlÉ™yÉ™n</h4>
                <p id="pending-developers">-</p>
              </div>
              <div class="user-info">
                <h4>âŒ RÉ™dd edilmiÅŸ</h4>
                <p id="rejected-developers">-</p>
              </div>
            </div>
            <div style="margin-top: 1rem;">
              <button id="load-stats-btn" class="btn btn-primary">ğŸ”„ StatistikalarÄ± yenilÉ™</button>
            </div>
          </div>
        </div>

        <!-- Pending Developer Requests -->
        <div class="admin-section" id="pending-developers-section">
          <h2>â³ GÃ¶zlÉ™yÉ™n Developer MÃ¼raciÉ™tlÉ™ri</h2>
          <div class="admin-content">
            <div id="pending-developers-list">
              <p>YÃ¼klÉ™nir...</p>
            </div>
            <div style="margin-top: 1rem;">
              <button id="load-pending-btn" class="btn btn-primary">ğŸ“‹ MÃ¼raciÉ™tlÉ™ri yenilÉ™</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/static/layout.js"></script>
  <script>
    // Admin panel JavaScript
    function esc(s) {
      s = String(s == null ? '' : s);
      return s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    function safePlan(plan) {
      const allowed = ['free','basic','pro','enterprise'];
      const p = String(plan || '').toLowerCase();
      return allowed.includes(p) ? p : 'free';
    }
    function safeRole(role) {
      const allowed = ['admin','developer','user'];
      const r = String(role || '').toLowerCase();
      return allowed.includes(r) ? r : 'user';
    }
    class AdminPanel {
      constructor() {
        this.currentUser = null;
        this.users = [];
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.checkAuthStatus();
      }

      setupEventListeners() {
        // Login form
        document.getElementById('login-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleLogin();
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
          this.handleLogout();
        });

        // Load users
        document.getElementById('load-users-btn').addEventListener('click', () => {
          this.loadUsers();
        });

        // Create user
        document.getElementById('create-user-btn').addEventListener('click', () => {
          this.showCreateUserForm();
        });

        document.getElementById('create-user-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleCreateUser();
        });

        document.getElementById('cancel-create-user').addEventListener('click', () => {
          this.hideCreateUserForm();
        });

        // Load stats
        document.getElementById('load-stats-btn').addEventListener('click', () => {
          this.loadStats();
        });

        // Load pending developers
        document.getElementById('load-pending-btn').addEventListener('click', () => {
          this.loadPendingDevelopers();
        });

        // Search and filter
        document.getElementById('search-users').addEventListener('input', () => {
          this.filterUsers();
        });

        document.getElementById('filter-plan').addEventListener('change', () => {
          this.filterUsers();
        });
      }

      async checkAuthStatus() {
        try {
          const response = await fetch('/api/auth/me');
          if (response.ok) {
            const user = await response.json();
            this.currentUser = user;
            this.showAdminInterface();
            // Load initial data
            this.loadStats();
            this.loadPendingDevelopers();
          } else {
            this.showLoginForm();
          }
        } catch (error) {
          console.error('Auth check failed:', error);
          this.showLoginForm();
        }
      }

      async handleLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        try {
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });

          if (response.ok) {
            const user = await response.json();
            this.currentUser = user;
            this.showAdminInterface();
            this.loadUsers();
            this.loadStats();
          } else {
            const error = await response.json();
            this.showError('GiriÅŸ uÄŸursuz: ' + error.message);
          }
        } catch (error) {
          this.showError('GiriÅŸ xÉ™tasÄ±: ' + error.message);
        }
      }

      async handleLogout() {
        try {
          await fetch('/api/auth/logout', { method: 'POST' });
          // Redirect to admin login page after logout
          window.location.href = '/admin-login.html';
        } catch (error) {
          console.error('Logout error:', error);
        }
      }

      showLoginForm() {
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('user-management-section').classList.add('hidden');
        document.getElementById('create-user-section').classList.add('hidden');
        document.getElementById('stats-section').classList.add('hidden');
        document.getElementById('admin-status').classList.remove('hidden');
        document.getElementById('admin-info').classList.add('hidden');
        document.getElementById('logout-btn').classList.add('hidden');
      }

      showAdminInterface() {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('user-management-section').classList.remove('hidden');
        document.getElementById('stats-section').classList.remove('hidden');
        document.getElementById('admin-status').classList.add('hidden');
        document.getElementById('admin-info').classList.remove('hidden');
        document.getElementById('logout-btn').classList.remove('hidden');
        
        document.getElementById('admin-name').textContent = this.currentUser.email;
        document.getElementById('admin-email').textContent = this.currentUser.email;
      }

      async loadUsers() {
        try {
          const response = await fetch('/api/admin/users');
          if (response.ok) {
            const data = await response.json();
            this.users = data.users;
            this.renderUsers();
          } else {
            const error = await response.json();
            this.showError('Ä°stifadÉ™Ã§ilÉ™r yÃ¼klÉ™nÉ™ bilmÉ™di: ' + error.message);
          }
        } catch (error) {
          this.showError('XÉ™ta: ' + error.message);
        }
      }

      renderUsers() {
        const container = document.getElementById('users-container');
        if (this.users.length === 0) {
          container.innerHTML = '<div class="loading">ğŸ” Ä°stifadÉ™Ã§i tapÄ±lmadÄ±</div>';
          return;
        }

        const html = this.users.map(user => `
          <div class="user-card">
            <h4>ğŸ‘¤ ${esc(user.email)}</h4>
            <p><strong>ğŸ†” ID:</strong> ${esc(user.id)}</p>
            <p><strong>ğŸ“‹ Plan:</strong> <span class="plan-badge plan-${safePlan(user.plan)}">${esc(user.plan)}</span></p>
            <p><strong>ğŸ“… YaradÄ±lÄ±b:</strong> ${new Date(user.createdAt).toLocaleDateString('az-AZ')}</p>
            ${user.planUpdatedAt ? `<p><strong>ğŸ”„ Plan yenilÉ™ndi:</strong> ${new Date(user.planUpdatedAt).toLocaleDateString('az-AZ')}</p>` : ''}
            ${user.role ? (()=>{ const r=safeRole(user.role); const cls = r==='admin'?'enterprise':(r==='developer'?'pro':'free'); const label = r==='admin'?'ğŸ‘‘ Admin':(r==='developer'?'ğŸ”§ Developer':'ğŸ‘¤ Ä°stifadÉ™Ã§i'); return `<p><strong>ğŸ‘‘ Rol:</strong> <span class=\"plan-badge plan-${cls}\">${label}</span></p>`; })() : ''}
            <div class="user-actions">
              <button class="btn btn-sm btn-primary" onclick="adminPanel.editUser('${user.id}')">âœï¸ RedaktÉ™ et</button>
              ${user.role === 'admin' ? 
                `<button class="btn btn-sm btn-warning" onclick="adminPanel.demoteUser('${user.id}')">â¬‡ï¸ Admin hÃ¼ququnu lÉ™ÄŸv et</button>` :
                `<button class="btn btn-sm btn-success" onclick="adminPanel.promoteUser('${user.id}')">ğŸ‘‘ Admin et</button>`
              }
              <button class="btn btn-sm btn-danger" onclick="adminPanel.deleteUser('${user.id}')">ğŸ—‘ï¸ Sil</button>
            </div>
          </div>
        `).join('');

        container.innerHTML = `<div class="users-grid">${html}</div>`;
      }

      filterUsers() {
        const search = document.getElementById('search-users').value.toLowerCase();
        const planFilter = document.getElementById('filter-plan').value;
        
        const filtered = this.users.filter(user => {
          const matchesSearch = user.email.toLowerCase().includes(search) || 
                               user.id.toLowerCase().includes(search) ||
                               (user.username && user.username.toLowerCase().includes(search)) ||
                               (user.displayName && user.displayName.toLowerCase().includes(search));
          const matchesPlan = !planFilter || user.plan === planFilter;
          return matchesSearch && matchesPlan;
        });

        const container = document.getElementById('users-container');
        if (filtered.length === 0) {
          container.innerHTML = '<div class="loading">ğŸ” AxtarÄ±ÅŸ nÉ™ticÉ™si tapÄ±lmadÄ±</div>';
          return;
        }

        const html = filtered.map(user => `
          <div class="user-card">
            <h4>ğŸ‘¤ ${esc(user.displayName || user.username || user.email)}</h4>
            <p><strong>ğŸ“§ E-poÃ§t:</strong> ${esc(user.email)}</p>
            ${user.username ? `<p><strong>ğŸ‘¤ Ä°stifadÉ™Ã§i adÄ±:</strong> ${esc(user.displayName || user.username)}</p>` : ''}
            <p><strong>ğŸ†” ID:</strong> ${esc(user.id)}</p>
            <p><strong>ğŸ“‹ Plan:</strong> <span class="plan-badge plan-${safePlan(user.plan)}">${esc(user.plan)}</span></p>
            <p><strong>ğŸ“… YaradÄ±lÄ±b:</strong> ${new Date(user.createdAt).toLocaleDateString('az-AZ')}</p>
            ${user.lastLoginAt ? `<p><strong>ğŸ” Son giriÅŸ:</strong> ${new Date(user.lastLoginAt).toLocaleDateString('az-AZ')}</p>` : ''}
            ${user.planUpdatedAt ? `<p><strong>ğŸ”„ Plan yenilÉ™ndi:</strong> ${new Date(user.planUpdatedAt).toLocaleDateString('az-AZ')}</p>` : ''}
            ${user.role ? (()=>{ const r=safeRole(user.role); const cls = r==='admin'?'enterprise':(r==='developer'?'pro':'free'); const label = r==='admin'?'ğŸ‘‘ Admin':(r==='developer'?'ğŸ”§ Developer':'ğŸ‘¤ Ä°stifadÉ™Ã§i'); return `<p><strong>ğŸ‘‘ Rol:</strong> <span class=\"plan-badge plan-${cls}\">${label}</span></p>`; })() : ''}
            ${user.analysisCount !== undefined ? `<p><strong>ğŸ“Š Analiz sayÄ±:</strong> ${String(user.analysisCount)}</p>` : ''}
            <div class="user-actions">
              <button class="btn btn-sm btn-primary" onclick="adminPanel.editUser('${user.id}')">âœï¸ RedaktÉ™ et</button>
              ${user.role === 'admin' ? 
                `<button class="btn btn-sm btn-warning" onclick="adminPanel.demoteUser('${user.id}')">â¬‡ï¸ Admin hÃ¼ququnu lÉ™ÄŸv et</button>` :
                `<button class="btn btn-sm btn-success" onclick="adminPanel.promoteUser('${user.id}')">ğŸ‘‘ Admin et</button>`
              }
              <button class="btn btn-sm btn-danger" onclick="adminPanel.deleteUser('${user.id}')">ğŸ—‘ï¸ Sil</button>
            </div>
          </div>
        `).join('');

        container.innerHTML = `<div class="users-grid">${html}</div>`;
      }

      showCreateUserForm() {
        document.getElementById('create-user-section').classList.remove('hidden');
      }

      hideCreateUserForm() {
        document.getElementById('create-user-section').classList.add('hidden');
        document.getElementById('create-user-form').reset();
      }

      async handleCreateUser() {
        const email = document.getElementById('new-user-email').value;
        const password = document.getElementById('new-user-password').value;
        const plan = document.getElementById('new-user-plan').value;

        try {
          const response = await fetch('/api/admin/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, plan })
          });

          if (response.ok) {
            this.showSuccess('Ä°stifadÉ™Ã§i uÄŸurla yaradÄ±ldÄ±');
            this.hideCreateUserForm();
            this.loadUsers();
            this.loadStats();
          } else {
            const error = await response.json();
            this.showError('Ä°stifadÉ™Ã§i yaradÄ±la bilmÉ™di: ' + error.message);
          }
        } catch (error) {
          this.showError('XÉ™ta: ' + error.message);
        }
      }

      async editUser(userId) {
        // Simple edit - just change plan for now
        const newPlan = prompt('Yeni plan (free/basic/pro/enterprise):');
        if (!newPlan || !['free', 'basic', 'pro', 'enterprise'].includes(newPlan)) return;

        try {
          const response = await fetch(`/api/admin/user/${userId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plan: newPlan })
          });

          if (response.ok) {
            this.showSuccess('Ä°stifadÉ™Ã§i yenilÉ™ndi');
            this.loadUsers();
            this.loadStats();
          } else {
            const error = await response.json();
            this.showError('YenilÉ™nmÉ™ uÄŸursuz: ' + error.message);
          }
        } catch (error) {
          this.showError('XÉ™ta: ' + error.message);
        }
      }

      async deleteUser(userId) {
        if (!confirm('Ä°stifadÉ™Ã§ini silmÉ™k istÉ™diyinizÉ™ É™minsiniz?')) return;

        try {
          const response = await fetch(`/api/admin/user/${userId}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            this.showSuccess('Ä°stifadÉ™Ã§i silindi');
            this.loadUsers();
            this.loadStats();
          } else {
            const error = await response.json();
            this.showError('SilinmÉ™ uÄŸursuz: ' + error.message);
          }
        } catch (error) {
          this.showError('XÉ™ta: ' + error.message);
        }
      }

      async loadStats() {
        try {
          const response = await fetch('/api/admin/users');
          if (response.ok) {
            const data = await response.json();
            const users = data.users;
            
            const stats = {
              total: users.length,
              free: users.filter(u => u.plan === 'free').length,
              basic: users.filter(u => u.plan === 'basic').length,
              pro: users.filter(u => u.plan === 'pro').length,
              enterprise: users.filter(u => u.plan === 'enterprise').length
            };

            document.getElementById('total-users').textContent = stats.total;
            document.getElementById('free-users').textContent = stats.free;
            document.getElementById('basic-users').textContent = stats.basic;
            document.getElementById('pro-users').textContent = stats.pro;
            document.getElementById('enterprise-users').textContent = stats.enterprise;
          }
        } catch (error) {
          console.error('Stats load error:', error);
        }
      }

      async promoteUser(userId) {
        if (!confirm('Bu istifadÉ™Ã§ini admin etmÉ™k istÉ™diyinizÉ™ É™minsiniz?')) return;

        try {
          const response = await fetch('/api/admin/promote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, action: 'promote' })
          });

          if (response.ok) {
            this.showSuccess('Ä°stifadÉ™Ã§i admin edildi');
            this.loadUsers();
          } else {
            const error = await response.json();
            this.showError('Admin etmÉ™ uÄŸursuz: ' + error.message);
          }
        } catch (error) {
          this.showError('XÉ™ta: ' + error.message);
        }
      }

      async demoteUser(userId) {
        if (!confirm('Bu istifadÉ™Ã§inin admin hÃ¼ququnu lÉ™ÄŸv etmÉ™k istÉ™diyinizÉ™ É™minsiniz?')) return;

        try {
          const response = await fetch('/api/admin/promote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, action: 'demote' })
          });

          if (response.ok) {
            this.showSuccess('Ä°stifadÉ™Ã§inin admin hÃ¼ququ lÉ™ÄŸv edildi');
            this.loadUsers();
          } else {
            const error = await response.json();
            this.showError('Admin hÃ¼ququnu lÉ™ÄŸv etmÉ™ uÄŸursuz: ' + error.message);
          }
        } catch (error) {
          this.showError('XÉ™ta: ' + error.message);
        }
      }

      showError(message) {
        const container = document.querySelector('.admin-content');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = message;
        container.insertBefore(errorDiv, container.firstChild);
        setTimeout(() => errorDiv.remove(), 5000);
      }

      showSuccess(message) {
        const container = document.querySelector('.admin-content');
        const successDiv = document.createElement('div');
        successDiv.className = 'success';
        successDiv.textContent = message;
        container.insertBefore(successDiv, container.firstChild);
        setTimeout(() => successDiv.remove(), 5000);
      }

      async loadStats() {
        try {
          const response = await fetch('/api/admin/statistics');
          if (response.ok) {
            const stats = await response.json();
            this.renderStats(stats);
          } else {
            this.showError('Statistikalar yÃ¼klÉ™nÉ™ bilmÉ™di');
          }
        } catch (error) {
          this.showError('XÉ™ta: ' + error.message);
        }
      }

      renderStats(stats) {
        document.getElementById('total-users').textContent = stats.total;
        document.getElementById('free-users').textContent = stats.free;
        document.getElementById('basic-users').textContent = stats.basic;
        document.getElementById('pro-users').textContent = stats.pro;
        document.getElementById('enterprise-users').textContent = stats.enterprise;
        
        // Developer statistics
        document.getElementById('total-developers').textContent = stats.developers;
        document.getElementById('approved-developers').textContent = stats.approvedDevelopers;
        document.getElementById('pending-developers').textContent = stats.pendingDevelopers;
        document.getElementById('rejected-developers').textContent = stats.rejectedDevelopers;
      }

      async loadPendingDevelopers() {
        try {
          const response = await fetch('/api/admin/pending-developers');
          if (response.ok) {
            const data = await response.json();
            this.renderPendingDevelopers(data.pendingRequests);
          } else {
            this.showError('MÃ¼raciÉ™tlÉ™r yÃ¼klÉ™nÉ™ bilmÉ™di');
          }
        } catch (error) {
          this.showError('XÉ™ta: ' + error.message);
        }
      }

      renderPendingDevelopers(requests) {
        const container = document.getElementById('pending-developers-list');
        
        if (requests.length === 0) {
          container.innerHTML = '<p>âœ… GÃ¶zlÉ™yÉ™n mÃ¼raciÉ™t yoxdur.</p>';
          return;
        }

        container.innerHTML = requests.map(request => `
          <div class="user-card" style="margin-bottom: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
            <h4>ğŸ”§ ${request.email}</h4>
            <p><strong>ğŸ¢ ÅirkÉ™t:</strong> ${request.company || 'TÉ™yin edilmÉ™yib'}</p>
            <p><strong>ğŸ’¡ API istifadÉ™ mÉ™qsÉ™di:</strong> ${request.reason}</p>
            <p><strong>ğŸ“… MÃ¼raciÉ™t tarixi:</strong> ${new Date(request.requestedAt).toLocaleDateString('az-AZ')}</p>
            <div class="user-actions" style="margin-top: 1rem;">
              <button class="btn btn-sm btn-success" onclick="adminPanel.approveDeveloper('${request.id}')">âœ… TÉ™sdiqlÉ™</button>
              <button class="btn btn-sm btn-danger" onclick="adminPanel.rejectDeveloper('${request.id}')">âŒ RÉ™dd et</button>
            </div>
          </div>
        `).join('');
      }

      async approveDeveloper(developerId) {
        if (!confirm('Bu developer mÃ¼raciÉ™tini tÉ™sdiqlÉ™mÉ™k istÉ™diyinizÉ™ É™minsiniz?')) return;

        try {
          const response = await fetch('/api/admin/approve-developer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ developerId, action: 'approve' })
          });

          if (response.ok) {
            this.showSuccess('Developer tÉ™sdiqlÉ™ndi');
            this.loadPendingDevelopers();
            this.loadStats();
          } else {
            const error = await response.json();
            this.showError('TÉ™sdiqlÉ™mÉ™ uÄŸursuz: ' + error.message);
          }
        } catch (error) {
          this.showError('XÉ™ta: ' + error.message);
        }
      }

      async rejectDeveloper(developerId) {
        if (!confirm('Bu developer mÃ¼raciÉ™tini rÉ™dd etmÉ™k istÉ™diyinizÉ™ É™minsiniz?')) return;

        try {
          const response = await fetch('/api/admin/approve-developer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ developerId, action: 'reject' })
          });

          if (response.ok) {
            this.showSuccess('Developer mÃ¼raciÉ™ti rÉ™dd edildi');
            this.loadPendingDevelopers();
            this.loadStats();
          } else {
            const error = await response.json();
            this.showError('RÉ™dd etmÉ™ uÄŸursuz: ' + error.message);
          }
        } catch (error) {
          this.showError('XÉ™ta: ' + error.message);
        }
      }
    }

    // Initialize admin panel when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      window.adminPanel = new AdminPanel();
    });
  </script>
</body>
</html>