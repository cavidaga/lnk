<!DOCTYPE html>
<html lang="az" class="no-js">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>LNK - Media qərəzi qiymətləndiricisi</title>
  <meta name="description" content="LNK.az - Azərbaycanın ilk süni intellektə əsaslanan media qərəzi analizatoru. İstənilən xəbər linkini daxil edin və məqalənin etibarlılığını, siyasi meylini və tərəfsizliyini anında qiymətləndirin." />
  <meta name="theme-color" content="#0c0d12">
  <meta name="color-scheme" content="light dark" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <!-- Google Fonts: Poppins -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Canonical & Open Graph -->
  <link rel="canonical" href="https://lnk.az/" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="LNK - Media qərəzi qiymətləndiricisi" />
  <meta property="og:description" content="Süni intellekt ilə media qərəzini yoxlayın. Xəbərləri və məqalələri bir kliklə analiz edin. Obyektiv məlumat üçün LNK.az." />
  <meta property="og:url" content="https://lnk.az/" />
  <meta property="og:image" content="https://lnk.az/static/og-cover.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="LNK - Media qərəzi qiymətləndiricisi" />
  <meta name="twitter:description" content="Süni intellekt ilə media qərəzini yoxlayın. Xəbərləri və məqalələri bir kliklə analiz edin. Obyektiv məlumat üçün LNK.az." />
  <meta name="twitter:image" content="https://lnk.az/static/og-cover.png" />
  <!-- Explicit icons so the browser doesn’t guess (and accidentally hit http://) -->
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/static/favicon.ico">
  <link rel="icon" href="/static/favicon-light.svg" media="(prefers-color-scheme: light)">
  <link rel="icon" href="/static/favicon-dark.svg"  media="(prefers-color-scheme: dark)">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
  <link rel="mask-icon" href="/static/safari-pinned-tab.svg" color="#e10600">

  <!-- Structured data -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebApplication",
    "name":"LNK - Media qərəzi qiymətləndiricisi",
    "url":"https://lnk.az/",
    "applicationCategory":"NewsApplication",
    "operatingSystem":"Any",
    "creator":{"@type":"Person","name":"Javid Agha","url":"https://cavid.info"}
  }
  </script>

<link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <a class="skip-link" href="#main">Mündəricata keç</a>
  <div class="wrap">
    <div id="site-header"></div>
    <main id="main" aria-labelledby="app-title">
      <div id="app-container">
        <div class="card" role="region" aria-label="Məqalə təhlili formu">
          <div class="bd">
            <div class="row">
              <label class="label" for="urlInput">Məqalə linki</label>
              <input class="input" id="urlInput" type="url" inputmode="url" placeholder="Məqalə linkini yapışdırın..." autocomplete="url" aria-describedby="helper" />
              <button class="btn" id="btn-analyse" type="button" aria-label="Məqaləni təhlil et">Təhlil et</button>
            </div>
            <div id="helper" class="small muted" style="margin-top:8px">Nümunə: https://abzas.org/az/2025/9/mhkmlrin-boksunda-donn1b5e8f6e-3/</div>
          </div>
        </div>
      </div>

      <div id="result" class="result" aria-live="polite"></div>
    </main>
    <div id="site-footer"></div>
  </div>

  <script>
    // Year in footer
    document.getElementById('y').textContent = new Date().getFullYear();

    const urlInput = document.getElementById('urlInput');
    const analyseBtn = document.getElementById('btn-analyse');
    const resultDiv = document.getElementById('result');
    const appContainer = document.getElementById('app-container');

    // --- ON PAGE LOAD: Checks for a shared analysis link ---
    document.addEventListener('DOMContentLoaded', () => {
        const path = window.location.pathname;
        const parts = path.split('/').filter(Boolean);
        if (parts[0] === 'analysis' && parts[1]) {
            const analysisId = parts[1];
            if (appContainer) appContainer.style.display = 'none';
            loadSharedAnalysis(analysisId);
        }
    });

    // --- Fetches a saved analysis from the database ---
    async function loadSharedAnalysis(id) {
        resultDiv.innerHTML = `<div class="loading"><span class="spinner"></span> <span>Saxlanmış analiz yüklənir…</span></div>`;
        resultDiv.classList.add('show');
        try {
            const response = await fetch(`/api/get-analysis?id=${id}`);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Analiz tapılmadı.');
            displayResult(data, false);
        } catch (error) {
            resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
        }
    }

    // --- MAIN DISPLAY FUNCTION: Renders the analysis report ---
    function displayResult(data, isNewAnalysis = true) {
        const { meta = {}, scores = {}, diagnostics = {}, cited_sources = [], human_summary = "Xülasə təqdim edilmədi." } = data;
        const reliability = scores.reliability?.value ?? 50;
        const politicalBias = scores.political_establishment_bias?.value ?? 0;
        const topPos = 100 - reliability;
        const leftPos = (politicalBias + 5) / 10 * 100;

        const sourcesTableHTML = cited_sources.length > 0 ? `
            <table class="sources-table">
              <thead><tr><th>Ad</th><th>Rol</th><th>Mövqe</th></tr></thead>
              <tbody>${cited_sources.map(s => `<tr><td>${escapeHTML(s.name)}</td><td>${escapeHTML(s.role)}</td><td>${escapeHTML(s.stance)}</td></tr>`).join('')}</tbody>
            </table>` : '<p class="muted small">Məqalədə birbaşa mənbə göstərilməyib.</p>';

        const languageFlagsHTML = diagnostics.language_flags?.length > 0
            ? `<ul>${diagnostics.language_flags.map(f => `<li><strong>${escapeHTML(f.term)}:</strong> <span class="muted">${escapeHTML(f.category)}</span></li>`).join('')}</ul>`
            : '<p class="muted small">Mənfi dil siqnalları aşkar edilmədi.</p>';

        let resultHTML = `
            <div class="analysis-grid">
              <div>
                <div class="bias-chart" role="img" aria-label="Etibarlılıq və siyasi meyl qrafiki">
                  <div class="chart-point" style="top:${topPos}%;left:${leftPos}%;"></div>
                  <span class="axis-label y-axis-top">Etibarlı</span><span class="axis-label y-axis-bottom">Etibarsız</span>
                  <span class="axis-label x-axis-left">Müxalif</span><span class="axis-label x-axis-right">Hökumətyönümlü</span>
                </div>
              </div>
              <div class="summary-card">
                ${meta.article_type ? `<div class="article-type-tag">${escapeHTML(meta.article_type)}</div>` : ''}
                <h4>Xülasə</h4>
                <p>${escapeHTML(human_summary).replace(/\n/g, '<br>')}</p>
              </div>
            </div>
            <div class="card" style="margin-top:20px;">
              <div class="bd">
                <h3 class="sec-title">Diaqnostik Göstəricilər</h3>
                <div class="diagnostics-grid">
                  <div class="diag-item"><div class="label">Dilin yüklülüyü</div><div class="value">${diagnostics.language_loadedness ?? 'N/A'}</div></div>
                  <div class="diag-item"><div class="label">Mənbə şəffaflığı</div><div class="value">${diagnostics.sourcing_transparency ?? 'N/A'}</div></div>
                  <div class="diag-item"><div class="label">Başlığın dəqiqliyi</div><div class="value">${diagnostics.headline_accuracy ?? 'N/A'}</div></div>
                </div>
                <h4 style="margin-top:20px;">Konkret dil siqnalları</h4>
                <div class="language-flags">${languageFlagsHTML}</div>
                <h3 class="sec-title">Mənbələr</h3>
                ${sourcesTableHTML}
                <h3 class="sec-title">Əsas oxlar üzrə izah</h3>
                <dl class="score-details">
                  <dt>Etibarlılıq: <span class="value">${scores.reliability?.value ?? 'N/A'}</span></dt>
                  <dd>${escapeHTML(scores.reliability?.rationale || '')}</dd>
                  <dt>Siyasi hakimiyyət meyli: <span class="value">${scores.political_establishment_bias?.value ?? 'N/A'}</span></dt>
                  <dd>${escapeHTML(scores.political_establishment_bias?.rationale || '')}</dd>
                  <dt>Sosial-mədəni meyl: <span class="value">${scores.socio_cultural_bias?.value ?? 'N/A'}</span></dt>
                  <dd>${escapeHTML(scores.socio_cultural_bias?.rationale || '')}</dd>
                </dl>
                <details>
                  <summary>Xam JSON datanı göstər</summary>
                  <pre>${escapeHTML(JSON.stringify(data, null, 2))}</pre>
                </details>
              </div>
            </div>`;

        if (isNewAnalysis && data.hash) {
            const shareableLink = `${window.location.origin}/analysis/${data.hash}`;
            resultHTML += `
                <div class="share-section">
                  <h4>Bu Analizi Paylaşın</h4>
                  <input type="text" readonly value="${shareableLink}" onclick="this.select();" aria-label="Paylaşım linki" />
                </div>`;
        }
        resultDiv.innerHTML = resultHTML;
    }

    function escapeHTML(s) {
        return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // --- MAIN NETWORK FUNCTION: Called when the user clicks the button ---
    async function analyzeUrl() {
        const url = urlInput.value.trim();
        if (!url || !url.startsWith('http')) {
            resultDiv.innerHTML = `<div class="error">Zəhmət olmasa, düzgün bir URL daxil edin.</div>`;
            resultDiv.classList.add('show');
            return;
        }

        analyseBtn.disabled = true;
        analyseBtn.textContent = 'Gözləyin...';
        resultDiv.innerHTML = `<div class="loading"><span class="spinner"></span> <span>Məqalə təhlil olunur… Bu, 45 saniyəyə qədər çəkə bilər.</span></div>`;
        resultDiv.classList.add('show');

        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            });
            const data = await response.json();

            if (!response.ok) {
                if (data.isBlockError) {
                    // This logic is for the "Click to Copy" prompt when a site is blocked
                    const errorHtml = `...`; // Your existing block error logic here
                    resultDiv.innerHTML = errorHtml;
                } else {
                    throw new Error(data.message || `Server error ${response.status}`);
                }
            } else {
                displayResult(data, true); // true = this is a new analysis
            }
        } catch (error) {
            console.error('Error details:', error);
            resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
        } finally {
            resultDiv.classList.add('show');
            analyseBtn.disabled = false;
            analyseBtn.textContent = 'Təhlil et';
        }
    }

    analyseBtn.addEventListener('click', analyzeUrl);
    urlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') analyzeUrl(); });
  </script>
  <script src="/static/layout.js" defer></script>
</body>
</html>
