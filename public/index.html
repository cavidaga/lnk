<!DOCTYPE html>
<html lang="az" class="no-js">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Media qərəzi qiymtləndiricisi</title>
  <meta name="theme-color" content="#0b0c10">
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #0b0c10; --panel: #111318; --muted: #8892a6; --text: #e8ecf1; --accent: #5aa9e6; --accent-2: #7ec9a3; --danger: #ef6461; --card: #0f1218; --border: #1f2430; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f9fc; --panel: #ffffff; --muted: #556070; --text: #0b1324; --accent: #006dca; --accent-2: #0a8754; --danger: #b42318; --card: #ffffff; --border: #e7ebf3; --shadow: 0 10px 24px rgba(10, 31, 68, .08);
      }
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans"; color: var(--text);
      background: radial-gradient(1200px 900px at 10% -10%, rgba(90,169,230,.18), transparent 60%), radial-gradient(1000px 700px at 110% 0%, rgba(126,201,163,.18), transparent 60%), var(--bg);
    }
    .wrap { max-width: 800px; margin: 0 auto; padding: 32px 20px 60px; }
    header { display: flex; align-items: center; gap: 14px; margin-bottom: 22px; }
    .logo-img { width:42px; height:42px; border-radius:12px; box-shadow:var(--shadow); display:block; }
    h1 { font-size: 26px; margin: 0; }
    .sub { color: var(--muted); margin-top: -4px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow); }
    .card > .bd { padding: 18px; }
    .row { display: grid; gap: 12px; grid-template-columns: 1fr 140px; }
    .input, .btn { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid var(--border); background: var(--panel); color: var(--text); font-size: 16px; outline: none; transition: all .2s ease; }
    .input:focus { border-color: var(--accent); }
    .btn { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #fff; border: 0; font-weight: 600; cursor: pointer; }
    .btn:hover { transform: translateY(-1px); }
    .btn:disabled { background: var(--border); cursor: not-allowed; transform: none; color: var(--muted); }
    .result { display: none; margin-top: 20px; }
    .result.show { display: block; }
    .loading { display: flex; align-items: center; justify-content: center; gap: 10px; color: var(--muted); padding: 40px 0; }
    .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,.25); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error { padding: 20px; text-align: center; border-radius: 10px; border: 1px solid var(--danger); background: rgba(239, 100, 97, 0.12); color: var(--danger); font-weight: 500; }
    .action-button { text-decoration: none; padding: 10px 20px; border-radius: 8px; background: var(--accent); color: white !important; font-weight: 500; }
    .analysis-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px;}
    @media (min-width: 768px) { .analysis-grid { grid-template-columns: 280px 1fr; } }
    .bias-chart { width: 100%; height: 280px; background-color: var(--panel); border: 1px solid var(--border); border-radius: 8px; position: relative; background-image: linear-gradient(var(--border) 1px, transparent 1px), linear-gradient(90deg, var(--border) 1px, transparent 1px); background-size: 100% 50%, 50% 100%; }
    .chart-point { position: absolute; width: 18px; height: 18px; background: radial-gradient(circle, #fff, var(--accent)); border-radius: 50%; transform: translate(-50%, -50%); border: 2px solid white; box-shadow: 0 0 15px rgba(90, 169, 230, 0.7); transition: top 0.5s ease-out, left 0.5s ease-out; }
    .axis-label { position: absolute; color: var(--muted); font-size: 10px; text-transform: uppercase; }
    .y-axis-top { top: 5px; left: 50%; transform: translateX(-50%); }
    .y-axis-bottom { bottom: 5px; left: 50%; transform: translateX(-50%); }
    .x-axis-left { left: 5px; top: 50%; transform: translateY(-50%) rotate(180deg); writing-mode: vertical-rl; }
    .x-axis-right { right: 5px; top: 50%; transform: translateY(-50%); writing-mode: vertical-rl; }
    .summary-card p { margin: 0; color: var(--muted); font-size: 15px;}
    .score-details dt { font-weight: 600; color: var(--text); margin-top: 1.2em; }
    .score-details dd { margin: 0.2em 0 0 1em; color: var(--muted); font-size: 14px; border-left: 2px solid var(--border); padding-left: 1em; }
    .score-details .value { font-family: monospace; color: var(--accent-2); font-weight: bold; }
    .sec-title { margin: 22px 0 8px; font-weight: 600; font-size: 18px; border-bottom: 1px solid var(--border); padding-bottom: 5px;}
    .article-type-tag { display: inline-block; background-color: var(--accent); color: white; padding: 4px 12px; border-radius: 999px; font-size: 14px; font-weight: 600; margin-bottom: 10px; }
    .sources-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
    .sources-table th, .sources-table td { text-align: left; padding: 8px; border-bottom: 1px solid var(--border); }
    .sources-table th { color: var(--muted); }
    .diagnostics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .diag-item { background-color: var(--panel); padding: 15px; border-radius: 8px; }
    .diag-item .label { font-size: 14px; color: var(--muted); }
    .diag-item .value { font-size: 24px; font-weight: 600; color: var(--text); }
    .language-flags { font-size: 14px; color: var(--muted); }
    details { margin-top: 20px; }
    summary { cursor: pointer; color: var(--muted); font-size: 14px; }
    pre { background-color: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 15px; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto; }
    .share-section { margin-top: 20px; padding: 15px; background-color: var(--panel); border-radius: 8px; text-align: center; }
    .share-section input { width: 100%; background-color: var(--bg); border: 1px solid var(--border); color: var(--muted); text-align: center; padding: 8px; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="/static/lnk.svg" alt="logo" class="logo-img" width="42" height="42" />
      <div>
        <h1>Media qərəzi qiymtləndiricisi</h1>
        <div class="sub">Bir Cavid Ağa layihəsidir</div>
      </div>
    </header>
    
    <div id="app-container">
        <div class="card">
            <div class="bd">
                <div class="row">
                    <input class="input" id="urlInput" type="url" placeholder="Məqalə linkini yapışdırın..." />
                    <button class="btn" id="btn-analyse">Təhlil et</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="result" class="result"></div>
  </div>

  <script>
    const urlInput = document.getElementById('urlInput');
    const analyseBtn = document.getElementById('btn-analyse');
    const resultDiv = document.getElementById('result');
    const appContainer = document.getElementById('app-container');

    // --- ON PAGE LOAD ---
    document.addEventListener('DOMContentLoaded', () => {
        const path = window.location.pathname;
        const parts = path.split('/').filter(Boolean);

        if (parts[0] === 'analysis' && parts[1]) {
            const analysisId = parts[1];
            if (appContainer) appContainer.style.display = 'none'; // Hide the input form
            loadSharedAnalysis(analysisId);
        }
    });

    async function loadSharedAnalysis(id) {
        resultDiv.innerHTML = `<div class="loading"><span class="spinner"></span> <span>Saxlanmış analiz yüklənir…</span></div>`;
        resultDiv.classList.add('show');
        try {
            const response = await fetch(`/api/get-analysis?id=${id}`);
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || 'Analiz tapılmadı.');
            }
            displayResult(data, false); // 'false' indicates it's a shared view, not a new analysis
        } catch (error) {
            resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
        }
    }
    
    // --- MAIN DISPLAY FUNCTION ---
    function displayResult(data, isNewAnalysis = true) {
        const { meta = {}, scores = {}, diagnostics = {}, cited_sources = [], human_summary = "Xülasə təqdim edilmədi." } = data;
        
        const reliability = scores.reliability?.value ?? 50;
        const politicalBias = scores.political_establishment_bias?.value ?? 0;
        const topPos = 100 - reliability;
        const leftPos = (politicalBias + 5) / 10 * 100;

        const sourcesTableHTML = cited_sources.length > 0 ? `
            <table class="sources-table">
                <thead><tr><th>Ad</th><th>Rol</th><th>Mövqe</th></tr></thead>
                <tbody>
                    ${cited_sources.map(s => `<tr><td>${escapeHTML(s.name)}</td><td>${escapeHTML(s.role)}</td><td>${escapeHTML(s.stance)}</td></tr>`).join('')}
                </tbody>
            </table>` : '<p class="muted small">Məqalədə birbaşa mənbə göstərilməyib.</p>';
        
        const languageFlagsHTML = diagnostics.language_flags?.length > 0 ?
            `<ul>${diagnostics.language_flags.map(f => `<li><strong>${escapeHTML(f.term)}:</strong> <span class="muted">${escapeHTML(f.category)}</span></li>`).join('')}</ul>` :
            '<p class="muted small">Mənfi dil siqnalları aşkar edilmədi.</p>';

        let resultHTML = `
            <div class="analysis-grid">
                <div>
                    <div class="bias-chart">
                        <div class="chart-point" style="top: ${topPos}%; left: ${leftPos}%;"></div>
                        <span class="axis-label y-axis-top">Etibarlı</span>
                        <span class="axis-label y-axis-bottom">Etibarsız</span>
                        <span class="axis-label x-axis-left">Müxalif</span>
                        <span class="axis-label x-axis-right">Hökumətyönümlü</span>
                    </div>
                </div>
                <div class="summary-card">
                    ${meta.article_type ? `<div class="article-type-tag">${escapeHTML(meta.article_type)}</div>` : ''}
                    <h4>Ümumi Xülasə</h4>
                    <p>${escapeHTML(human_summary).replace(/\n/g, '<br>')}</p>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <div class="bd">
                    <h3 class="sec-title">Diaqnostik Göstəricilər</h3>
                    <div class="diagnostics-grid">
                        <div class="diag-item"><div class="label">Dilin yüklülüyü</div><div class="value">${diagnostics.language_loadedness ?? 'N/A'}</div></div>
                        <div class="diag-item"><div class="label">Mənbə şəffaflığı</div><div class="value">${diagnostics.sourcing_transparency ?? 'N/A'}</div></div>
                        <div class="diag-item"><div class="label">Başlığın dəqiqliyi</div><div class="value">${diagnostics.headline_accuracy ?? 'N/A'}</div></div>
                    </div>
                    <h4 style="margin-top: 20px;">Konkret Dil Siqnalları</h4>
                    <div class="language-flags">${languageFlagsHTML}</div>
                    <h3 class="sec-title">Mənbələr</h3>
                    ${sourcesTableHTML}
                    <h3 class="sec-title">Əsas Oxlar üzrə izah</h3>
                    <dl class="score-details">
                        <dt>Etibarlılıq: <span class="value">${scores.reliability?.value ?? 'N/A'}</span></dt>
                        <dd>${escapeHTML(scores.reliability?.rationale || '')}</dd>
                        <dt>Siyasi hakimiyyət meyli: <span class="value">${scores.political_establishment_bias?.value ?? 'N/A'}</span></dt>
                        <dd>${escapeHTML(scores.political_establishment_bias?.rationale || '')}</dd>
                        <dt>Sosial-Mədəni Meyl: <span class="value">${scores.socio_cultural_bias?.value ?? 'N/A'}</span></dt>
                        <dd>${escapeHTML(scores.socio_cultural_bias?.rationale || '')}</dd>
                    </dl>
                    <details>
                        <summary>Xam JSON datanı göstər</summary>
                        <pre>${escapeHTML(JSON.stringify(data, null, 2))}</pre>
                    </details>
                </div>
            </div>
        `;
        
        // --- CORRECTED: Add the Shareable Link section ---
        if (isNewAnalysis && data.hash) {
            const shareableLink = `${window.location.origin}/analysis/${data.hash}`;
            resultHTML += `
                <div class="share-section">
                    <h4>Bu analizi paylaşın</h4>
                    <input type="text" readonly value="${shareableLink}" onclick="this.select(); document.execCommand('copy');" />
                </div>
            `;
        }
        
        resultDiv.innerHTML = resultHTML;
    }
    
    function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    async function analyzeUrl() {
        const url = urlInput.value.trim();
        if (!url || !url.startsWith('http')) {
            resultDiv.innerHTML = `<div class="error">Zəhmət olmasa, düzgün bir URL daxil edin.</div>`;
            resultDiv.classList.add('show');
            return;
        }

        analyseBtn.disabled = true;
        analyseBtn.textContent = 'Gözləyin...';
        resultDiv.innerHTML = `<div class="loading"><span class="spinner"></span> <span>Məqalə təhlil olunur… Bu, 45 saniyəyə qədər çəkə bilər.</span></div>`;
        resultDiv.classList.add('show');
      
        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            });

            const data = await response.json();

            if (!response.ok) {
                if (data.isBlockError) {
                    const errorHtml = `
                        <div class="error">
                            <p>${data.message}</p>
                            <div style="margin-top: 15px;">
                                <a href="https://gemini.google.com" target="_blank" rel="noopener noreferrer" class="action-button">Gemini'ni açın və promtu kopyalayın</a>
                            </div>
                        </div>`;
                    resultDiv.innerHTML = errorHtml;
                } else {
                    throw new Error(data.message || `Server error ${response.status}`);
                }
            } else {
                displayResult(data);
            }

        } catch (error) {
            console.error('Error details:', error);
            resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
        } finally {
            resultDiv.classList.add('show');
            analyseBtn.disabled = false;
            analyseBtn.textContent = 'Təhlil et';
        }
    }

    analyseBtn.addEventListener('click', analyzeUrl);
    urlInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        analyzeUrl();
      }
    });
  </script>
</body>
</html>
