<!DOCTYPE html>
<html lang="az" class="no-js">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />

  <title>LNK.az Admin Paneli</title>
  <meta name="description" content="LNK.az Admin Paneli - ƒ∞stifad…ô√ßi idar…ôetm…ôsi v…ô sistem konfiqurasiyasƒ±" />
  <meta name="theme-color" content="#0c0d12">
  <meta name="color-scheme" content="light dark" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/static/favicon.ico">
  <link rel="icon" href="/static/favicon-light.svg" media="(prefers-color-scheme: light)">
  <link rel="icon" href="/static/favicon-dark.svg"  media="(prefers-color-scheme: dark)">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">

  <link rel="stylesheet" href="/static/styles.css">
  
  <style>
    /* Admin-specific styles */
    .admin-header {
      text-align: center;
      margin-bottom: 2rem;
      padding: 2rem;
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
      border-radius: 12px;
    }
    
    .admin-header h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }
    
    .admin-header p {
      font-size: 1.2rem;
      opacity: 0.9;
    }
    
    .admin-section {
      margin-bottom: 2rem;
    }
    
    .admin-section h2 {
      background: var(--panel);
      padding: 1.5rem;
      margin: 0 0 0 0;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      font-size: 1.5rem;
      border-radius: 12px 12px 0 0;
    }
    
    .admin-content {
      padding: 1.5rem;
      background: var(--card);
      border-radius: 0 0 12px 12px;
      border: 1px solid var(--border);
      border-top: none;
    }
    
    .user-info {
      background: var(--panel);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }
    
    .user-info h3 {
      margin: 0 0 0.5rem 0;
      color: var(--text);
    }
    
    .user-info p {
      margin: 0.25rem 0;
      color: var(--muted);
    }
    
    .hidden {
      display: none;
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    
    .status-online {
      background-color: #28a745;
    }
    
    .status-offline {
      background-color: #dc3545;
    }
    
    .users-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .user-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.2s ease;
    }
    
    .user-card:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .user-card h4 {
      margin: 0 0 0.5rem 0;
      color: var(--text);
    }
    
    .user-card p {
      margin: 0.25rem 0;
      color: var(--muted);
      font-size: 0.9rem;
    }
    
    .user-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
    }
    
    .plan-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .plan-free {
      background: #e9ecef;
      color: #495057;
    }
    
    .plan-pro {
      background: #d4edda;
      color: #155724;
    }
    
    .plan-enterprise {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--muted);
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    
    .success {
      background: #d4edda;
      color: #155724;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="site-header"></div>
    <main id="main" role="main">
      <div class="admin-panel">
        <div class="admin-header">
          <h1>üõ°Ô∏è LNK.az Admin Paneli</h1>
          <p>ƒ∞stifad…ô√ßi idar…ôetm…ôsi v…ô sistem konfiqurasiyasƒ±</p>
        </div>

        <!-- Admin Status -->
        <div class="admin-section">
          <h2>Admin Statusu</h2>
          <div class="admin-content">
            <div id="admin-status">
              <div class="status-indicator status-offline"></div>
              <span>Admin hesabƒ±na daxil olunmayƒ±b</span>
            </div>
            <div id="admin-info" class="user-info hidden">
              <h3 id="admin-name">Admin</h3>
              <p id="admin-email">admin@example.com</p>
              <p>Rol: Sistem Administratoru</p>
            </div>
            <div style="margin-top: 1rem;">
              <button id="logout-btn" class="btn btn-danger hidden">√áƒ±xƒ±≈ü</button>
            </div>
          </div>
        </div>

        <!-- Login Form -->
        <div class="admin-section" id="login-section">
          <h2>Admin Daxil Ol</h2>
          <div class="admin-content">
            <form id="login-form">
              <div class="form-group">
                <label for="login-email">E-po√ßt</label>
                <input type="email" id="login-email" required>
              </div>
              <div class="form-group">
                <label for="login-password">≈ûifr…ô</label>
                <input type="password" id="login-password" required>
              </div>
              <button type="submit" class="btn btn-primary">Daxil ol</button>
            </form>
          </div>
        </div>

        <!-- User Management -->
        <div class="admin-section" id="user-management-section">
          <h2>ƒ∞stifad…ô√ßi ƒ∞dar…ôetm…ôsi</h2>
          <div class="admin-content">
            <div class="form-row">
              <div class="form-group">
                <label for="search-users">ƒ∞stifad…ô√ßi axtar</label>
                <input type="text" id="search-users" placeholder="E-po√ßt v…ô ya ID il…ô axtar...">
              </div>
              <div class="form-group">
                <label for="filter-plan">Plan filtri</label>
                <select id="filter-plan">
                  <option value="">B√ºt√ºn planlar</option>
                  <option value="free">Pulsuz</option>
                  <option value="basic">∆èsas</option>
                  <option value="pro">Pro</option>
                  <option value="enterprise">Enterprise</option>
                </select>
              </div>
            </div>
            
            <div class="button-group" style="margin: 1rem 0;">
              <button id="load-users-btn" class="btn btn-primary">ƒ∞stifad…ô√ßil…ôri y√ºkl…ô</button>
              <button id="create-user-btn" class="btn btn-success">Yeni istifad…ô√ßi yarat</button>
            </div>

            <div id="users-container">
              <div class="loading">ƒ∞stifad…ô√ßil…ôr y√ºkl…ônir...</div>
            </div>
          </div>
        </div>

        <!-- Create User Form -->
        <div class="admin-section" id="create-user-section">
          <h2>Yeni ƒ∞stifad…ô√ßi Yarat</h2>
          <div class="admin-content">
            <form id="create-user-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="new-user-email">E-po√ßt</label>
                  <input type="email" id="new-user-email" required>
                </div>
                <div class="form-group">
                  <label for="new-user-password">≈ûifr…ô</label>
                  <input type="password" id="new-user-password" minlength="8" required>
                </div>
              </div>
              <div class="form-group">
                <label for="new-user-plan">Plan</label>
                <select id="new-user-plan">
                  <option value="free">Pulsuz</option>
                  <option value="basic">∆èsas</option>
                  <option value="pro">Pro</option>
                  <option value="enterprise">Enterprise</option>
                </select>
              </div>
              <div class="button-group">
                <button type="submit" class="btn btn-success">ƒ∞stifad…ô√ßi yarat</button>
                <button type="button" id="cancel-create-user" class="btn btn-secondary">L…ôƒüv et</button>
              </div>
            </form>
          </div>
        </div>

        <!-- System Statistics -->
        <div class="admin-section" id="stats-section">
          <h2>Sistem Statistikalarƒ±</h2>
          <div class="admin-content">
            <div class="form-row">
              <div class="user-info">
                <h4>√úmumi ƒ∞stifad…ô√ßil…ôr</h4>
                <p id="total-users">-</p>
              </div>
              <div class="user-info">
                <h4>Pulsuz Plan</h4>
                <p id="free-users">-</p>
              </div>
              <div class="user-info">
                <h4>∆èsas Plan</h4>
                <p id="basic-users">-</p>
              </div>
              <div class="user-info">
                <h4>Pro Plan</h4>
                <p id="pro-users">-</p>
              </div>
              <div class="user-info">
                <h4>Enterprise Plan</h4>
                <p id="enterprise-users">-</p>
              </div>
            </div>
            <div style="margin-top: 1rem;">
              <button id="load-stats-btn" class="btn btn-primary">Statistikalarƒ± yenil…ô</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/static/layout.js"></script>
  <script>
    // Admin panel JavaScript
    class AdminPanel {
      constructor() {
        this.currentUser = null;
        this.users = [];
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.checkAuthStatus();
      }

      setupEventListeners() {
        // Login form
        document.getElementById('login-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleLogin();
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
          this.handleLogout();
        });

        // Load users
        document.getElementById('load-users-btn').addEventListener('click', () => {
          this.loadUsers();
        });

        // Create user
        document.getElementById('create-user-btn').addEventListener('click', () => {
          this.showCreateUserForm();
        });

        document.getElementById('create-user-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleCreateUser();
        });

        document.getElementById('cancel-create-user').addEventListener('click', () => {
          this.hideCreateUserForm();
        });

        // Load stats
        document.getElementById('load-stats-btn').addEventListener('click', () => {
          this.loadStats();
        });

        // Search and filter
        document.getElementById('search-users').addEventListener('input', () => {
          this.filterUsers();
        });

        document.getElementById('filter-plan').addEventListener('change', () => {
          this.filterUsers();
        });
      }

      async checkAuthStatus() {
        try {
          const response = await fetch('/api/auth/me');
          if (response.ok) {
            const user = await response.json();
            this.currentUser = user;
            this.showAdminInterface();
          } else {
            this.showLoginForm();
          }
        } catch (error) {
          console.error('Auth check failed:', error);
          this.showLoginForm();
        }
      }

      async handleLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        try {
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });

          if (response.ok) {
            const user = await response.json();
            this.currentUser = user;
            this.showAdminInterface();
            this.loadUsers();
            this.loadStats();
          } else {
            const error = await response.json();
            this.showError('Giri≈ü uƒüursuz: ' + error.message);
          }
        } catch (error) {
          this.showError('Giri≈ü x…ôtasƒ±: ' + error.message);
        }
      }

      async handleLogout() {
        try {
          await fetch('/api/auth/logout', { method: 'POST' });
          this.currentUser = null;
          this.showLoginForm();
        } catch (error) {
          console.error('Logout error:', error);
        }
      }

      showLoginForm() {
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('user-management-section').classList.add('hidden');
        document.getElementById('create-user-section').classList.add('hidden');
        document.getElementById('stats-section').classList.add('hidden');
        document.getElementById('admin-status').classList.remove('hidden');
        document.getElementById('admin-info').classList.add('hidden');
        document.getElementById('logout-btn').classList.add('hidden');
      }

      showAdminInterface() {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('user-management-section').classList.remove('hidden');
        document.getElementById('stats-section').classList.remove('hidden');
        document.getElementById('admin-status').classList.add('hidden');
        document.getElementById('admin-info').classList.remove('hidden');
        document.getElementById('logout-btn').classList.remove('hidden');
        
        document.getElementById('admin-name').textContent = this.currentUser.email;
        document.getElementById('admin-email').textContent = this.currentUser.email;
      }

      async loadUsers() {
        try {
          const response = await fetch('/api/admin/users');
          if (response.ok) {
            const data = await response.json();
            this.users = data.users;
            this.renderUsers();
          } else {
            const error = await response.json();
            this.showError('ƒ∞stifad…ô√ßil…ôr y√ºkl…ôn…ô bilm…ôdi: ' + error.message);
          }
        } catch (error) {
          this.showError('X…ôta: ' + error.message);
        }
      }

      renderUsers() {
        const container = document.getElementById('users-container');
        if (this.users.length === 0) {
          container.innerHTML = '<div class="loading">ƒ∞stifad…ô√ßi tapƒ±lmadƒ±</div>';
          return;
        }

        const html = this.users.map(user => `
          <div class="user-card">
            <h4>${user.email}</h4>
            <p><strong>ID:</strong> ${user.id}</p>
            <p><strong>Plan:</strong> <span class="plan-badge plan-${user.plan}">${user.plan}</span></p>
            <p><strong>Yaradƒ±lƒ±b:</strong> ${new Date(user.createdAt).toLocaleDateString('az-AZ')}</p>
            ${user.planUpdatedAt ? `<p><strong>Plan yenil…ôndi:</strong> ${new Date(user.planUpdatedAt).toLocaleDateString('az-AZ')}</p>` : ''}
            ${user.role ? `<p><strong>Rol:</strong> <span class="plan-badge plan-${user.role === 'admin' ? 'enterprise' : 'free'}">${user.role === 'admin' ? 'Admin' : 'ƒ∞stifad…ô√ßi'}</span></p>` : ''}
            <div class="user-actions">
              <button class="btn btn-sm btn-primary" onclick="adminPanel.editUser('${user.id}')">Redakt…ô et</button>
              ${user.role === 'admin' ? 
                `<button class="btn btn-sm btn-warning" onclick="adminPanel.demoteUser('${user.id}')">Admin h√ºququnu l…ôƒüv et</button>` :
                `<button class="btn btn-sm btn-success" onclick="adminPanel.promoteUser('${user.id}')">Admin et</button>`
              }
              <button class="btn btn-sm btn-danger" onclick="adminPanel.deleteUser('${user.id}')">Sil</button>
            </div>
          </div>
        `).join('');

        container.innerHTML = `<div class="users-grid">${html}</div>`;
      }

      filterUsers() {
        const search = document.getElementById('search-users').value.toLowerCase();
        const planFilter = document.getElementById('filter-plan').value;
        
        const filtered = this.users.filter(user => {
          const matchesSearch = user.email.toLowerCase().includes(search) || 
                               user.id.toLowerCase().includes(search);
          const matchesPlan = !planFilter || user.plan === planFilter;
          return matchesSearch && matchesPlan;
        });

        const container = document.getElementById('users-container');
        if (filtered.length === 0) {
          container.innerHTML = '<div class="loading">Axtarƒ±≈ü n…ôtic…ôsi tapƒ±lmadƒ±</div>';
          return;
        }

        const html = filtered.map(user => `
          <div class="user-card">
            <h4>${user.email}</h4>
            <p><strong>ID:</strong> ${user.id}</p>
            <p><strong>Plan:</strong> <span class="plan-badge plan-${user.plan}">${user.plan}</span></p>
            <p><strong>Yaradƒ±lƒ±b:</strong> ${new Date(user.createdAt).toLocaleDateString('az-AZ')}</p>
            ${user.planUpdatedAt ? `<p><strong>Plan yenil…ôndi:</strong> ${new Date(user.planUpdatedAt).toLocaleDateString('az-AZ')}</p>` : ''}
            ${user.role ? `<p><strong>Rol:</strong> <span class="plan-badge plan-${user.role === 'admin' ? 'enterprise' : 'free'}">${user.role === 'admin' ? 'Admin' : 'ƒ∞stifad…ô√ßi'}</span></p>` : ''}
            <div class="user-actions">
              <button class="btn btn-sm btn-primary" onclick="adminPanel.editUser('${user.id}')">Redakt…ô et</button>
              ${user.role === 'admin' ? 
                `<button class="btn btn-sm btn-warning" onclick="adminPanel.demoteUser('${user.id}')">Admin h√ºququnu l…ôƒüv et</button>` :
                `<button class="btn btn-sm btn-success" onclick="adminPanel.promoteUser('${user.id}')">Admin et</button>`
              }
              <button class="btn btn-sm btn-danger" onclick="adminPanel.deleteUser('${user.id}')">Sil</button>
            </div>
          </div>
        `).join('');

        container.innerHTML = `<div class="users-grid">${html}</div>`;
      }

      showCreateUserForm() {
        document.getElementById('create-user-section').classList.remove('hidden');
      }

      hideCreateUserForm() {
        document.getElementById('create-user-section').classList.add('hidden');
        document.getElementById('create-user-form').reset();
      }

      async handleCreateUser() {
        const email = document.getElementById('new-user-email').value;
        const password = document.getElementById('new-user-password').value;
        const plan = document.getElementById('new-user-plan').value;

        try {
          const response = await fetch('/api/admin/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, plan })
          });

          if (response.ok) {
            this.showSuccess('ƒ∞stifad…ô√ßi uƒüurla yaradƒ±ldƒ±');
            this.hideCreateUserForm();
            this.loadUsers();
            this.loadStats();
          } else {
            const error = await response.json();
            this.showError('ƒ∞stifad…ô√ßi yaradƒ±la bilm…ôdi: ' + error.message);
          }
        } catch (error) {
          this.showError('X…ôta: ' + error.message);
        }
      }

      async editUser(userId) {
        // Simple edit - just change plan for now
        const newPlan = prompt('Yeni plan (free/basic/pro/enterprise):');
        if (!newPlan || !['free', 'basic', 'pro', 'enterprise'].includes(newPlan)) return;

        try {
          const response = await fetch(`/api/admin/user/${userId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plan: newPlan })
          });

          if (response.ok) {
            this.showSuccess('ƒ∞stifad…ô√ßi yenil…ôndi');
            this.loadUsers();
            this.loadStats();
          } else {
            const error = await response.json();
            this.showError('Yenil…ônm…ô uƒüursuz: ' + error.message);
          }
        } catch (error) {
          this.showError('X…ôta: ' + error.message);
        }
      }

      async deleteUser(userId) {
        if (!confirm('ƒ∞stifad…ô√ßini silm…ôk ist…ôdiyiniz…ô …ôminsiniz?')) return;

        try {
          const response = await fetch(`/api/admin/user/${userId}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            this.showSuccess('ƒ∞stifad…ô√ßi silindi');
            this.loadUsers();
            this.loadStats();
          } else {
            const error = await response.json();
            this.showError('Silinm…ô uƒüursuz: ' + error.message);
          }
        } catch (error) {
          this.showError('X…ôta: ' + error.message);
        }
      }

      async loadStats() {
        try {
          const response = await fetch('/api/admin/users');
          if (response.ok) {
            const data = await response.json();
            const users = data.users;
            
            const stats = {
              total: users.length,
              free: users.filter(u => u.plan === 'free').length,
              basic: users.filter(u => u.plan === 'basic').length,
              pro: users.filter(u => u.plan === 'pro').length,
              enterprise: users.filter(u => u.plan === 'enterprise').length
            };

            document.getElementById('total-users').textContent = stats.total;
            document.getElementById('free-users').textContent = stats.free;
            document.getElementById('basic-users').textContent = stats.basic;
            document.getElementById('pro-users').textContent = stats.pro;
            document.getElementById('enterprise-users').textContent = stats.enterprise;
          }
        } catch (error) {
          console.error('Stats load error:', error);
        }
      }

      async promoteUser(userId) {
        if (!confirm('Bu istifad…ô√ßini admin etm…ôk ist…ôdiyiniz…ô …ôminsiniz?')) return;

        try {
          const response = await fetch('/api/admin/promote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, action: 'promote' })
          });

          if (response.ok) {
            this.showSuccess('ƒ∞stifad…ô√ßi admin edildi');
            this.loadUsers();
          } else {
            const error = await response.json();
            this.showError('Admin etm…ô uƒüursuz: ' + error.message);
          }
        } catch (error) {
          this.showError('X…ôta: ' + error.message);
        }
      }

      async demoteUser(userId) {
        if (!confirm('Bu istifad…ô√ßinin admin h√ºququnu l…ôƒüv etm…ôk ist…ôdiyiniz…ô …ôminsiniz?')) return;

        try {
          const response = await fetch('/api/admin/promote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, action: 'demote' })
          });

          if (response.ok) {
            this.showSuccess('ƒ∞stifad…ô√ßinin admin h√ºququ l…ôƒüv edildi');
            this.loadUsers();
          } else {
            const error = await response.json();
            this.showError('Admin h√ºququnu l…ôƒüv etm…ô uƒüursuz: ' + error.message);
          }
        } catch (error) {
          this.showError('X…ôta: ' + error.message);
        }
      }

      showError(message) {
        const container = document.querySelector('.admin-content');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = message;
        container.insertBefore(errorDiv, container.firstChild);
        setTimeout(() => errorDiv.remove(), 5000);
      }

      showSuccess(message) {
        const container = document.querySelector('.admin-content');
        const successDiv = document.createElement('div');
        successDiv.className = 'success';
        successDiv.textContent = message;
        container.insertBefore(successDiv, container.firstChild);
        setTimeout(() => successDiv.remove(), 5000);
      }
    }

    // Initialize admin panel when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      window.adminPanel = new AdminPanel();
    });
  </script>
</body>
</html>