<!DOCTYPE html>
<html lang="az" class="no-js">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />

  <title>ƒ∞stifad…ô√ßi Paneli - LNK.az</title>
  <meta name="description" content="LNK.az - ƒ∞stifad…ô√ßi paneli. Analiz tarix√ß…ônizi g√∂r√ºn v…ô idar…ô edin." />
  <meta name="theme-color" content="#0c0d12">
  <meta name="color-scheme" content="light dark" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/static/favicon.ico">
  <link rel="icon" href="/static/favicon-light.svg" media="(prefers-color-scheme: light)">
  <link rel="icon" href="/static/favicon-dark.svg"  media="(prefers-color-scheme: dark)">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">

  <link rel="stylesheet" href="/static/styles.css">
  
  <style>
    .dashboard-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .dashboard-header {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }

    .dashboard-header h1 {
      color: #1f2937;
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .dashboard-header p {
      color: #6b7280;
      font-size: 1rem;
    }

    .user-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
      text-align: center;
    }

    .stat-card h3 {
      color: #6b7280;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-card p {
      color: #1f2937;
      font-size: 2rem;
      font-weight: 700;
      margin: 0;
    }

    .analyses-section {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }

    .analyses-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .analyses-header h2 {
      color: #1f2937;
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .analyses-list {
      display: grid;
      gap: 1rem;
    }

    .analysis-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid #e9ecef;
      transition: all 0.2s;
    }

    .analysis-item:hover {
      background: #f1f3f4;
      border-color: #d1d5db;
    }

    .analysis-item h3 {
      color: #1f2937;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .analysis-item p {
      color: #6b7280;
      font-size: 0.875rem;
      margin: 0.25rem 0;
    }

    .analysis-meta {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: #6b7280;
      font-size: 0.75rem;
    }

    .reliability-score {
      font-weight: 600;
    }

    .reliability-high { color: #16a34a; }
    .reliability-medium { color: #d97706; }
    .reliability-low { color: #dc2626; }

    .bias-score {
      font-weight: 600;
    }

    .bias-positive { color: #dc2626; }
    .bias-neutral { color: #6b7280; }
    .bias-negative { color: #2563eb; }

    .loading {
      text-align: center;
      color: #6b7280;
      font-size: 0.875rem;
      padding: 2rem;
    }

    .error-message {
      background: #fef2f2;
      color: #dc2626;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      border: 1px solid #fecaca;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6b7280;
    }

    .empty-state h3 {
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .hidden {
      display: none;
    }

    .auth-required {
      text-align: center;
      padding: 3rem 1rem;
    }

    .auth-required h2 {
      color: #1f2937;
      margin-bottom: 1rem;
    }

    .auth-required p {
      color: #6b7280;
      margin-bottom: 1.5rem;
    }

    .auth-links {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      .dashboard-header {
        background: var(--card) !important;
        border-color: var(--border) !important;
      }
      
      .dashboard-header h1 {
        color: var(--text) !important;
      }
      
      .dashboard-header p {
        color: var(--muted) !important;
      }
      
      .stat-card {
        background: var(--card) !important;
        border-color: var(--border) !important;
      }
      
      .stat-card h3 {
        color: var(--muted) !important;
      }
      
      .stat-card p {
        color: var(--text) !important;
      }
      
      .analyses-section {
        background: var(--card) !important;
        border-color: var(--border) !important;
      }
      
      .analyses-header h2 {
        color: var(--text) !important;
      }
      
      .analysis-item {
        background: var(--panel) !important;
        border-color: var(--border) !important;
      }
      
      .analysis-item:hover {
        background: var(--bg) !important;
      }
      
      .analysis-item h3 {
        color: var(--text) !important;
      }
      
      .analysis-item p {
        color: var(--muted) !important;
      }
      
      .meta-item {
        color: var(--muted) !important;
      }
      
      .auth-required h2 {
        color: var(--text) !important;
      }
      
      .auth-required p {
        color: var(--muted) !important;
      }
      
      .error-message {
        background: #2d1b1b !important;
        color: #fca5a5 !important;
        border-color: #7f1d1d !important;
      }
      
      .empty-state h3 {
        color: var(--text) !important;
      }
      
      .empty-state {
        color: var(--muted) !important;
      }
    }
    
    .theme-dark .dashboard-header {
      background: var(--card) !important;
      border-color: var(--border) !important;
    }
    
    .theme-dark .dashboard-header h1 {
      color: var(--text) !important;
    }
    
    .theme-dark .dashboard-header p {
      color: var(--muted) !important;
    }
    
    .theme-dark .stat-card {
      background: var(--card) !important;
      border-color: var(--border) !important;
    }
    
    .theme-dark .stat-card h3 {
      color: var(--muted) !important;
    }
    
    .theme-dark .stat-card p {
      color: var(--text) !important;
    }
    
    .theme-dark .analyses-section {
      background: var(--card) !important;
      border-color: var(--border) !important;
    }
    
    .theme-dark .analyses-header h2 {
      color: var(--text) !important;
    }
    
    .theme-dark .analysis-item {
      background: var(--panel) !important;
      border-color: var(--border) !important;
    }
    
    .theme-dark .analysis-item:hover {
      background: var(--bg) !important;
    }
    
    .theme-dark .analysis-item h3 {
      color: var(--text) !important;
    }
    
    .theme-dark .analysis-item p {
      color: var(--muted) !important;
    }
    
    .theme-dark .meta-item {
      color: var(--muted) !important;
    }
    
    .theme-dark .auth-required h2 {
      color: var(--text) !important;
    }
    
    .theme-dark .auth-required p {
      color: var(--muted) !important;
    }
    
    .theme-dark .error-message {
      background: #2d1b1b !important;
      color: #fca5a5 !important;
      border-color: #7f1d1d !important;
    }
    
    .theme-dark .empty-state h3 {
      color: var(--text) !important;
    }
    
    .theme-dark .empty-state {
      color: var(--muted) !important;
    }
  </style>
</head>

<body>
  <a class="skip-link" href="#main">M√ºnd…ôricata ke√ß</a>
  <div class="wrap">
    <div id="site-header"></div>

    <main id="main" aria-labelledby="app-title">
      <div class="container">
        <div class="dashboard-container">
        <!-- Auth required message -->
        <div id="auth-required" class="auth-required hidden">
          <h2>üîê Daxil olmaq lazƒ±mdƒ±r</h2>
          <p>Bu s…ôhif…ôni g√∂rm…ôk √º√ß√ºn hesabƒ±nƒ±za daxil olmalƒ±sƒ±nƒ±z.</p>
          <div class="auth-links">
            <a href="/user-login.html" class="btn btn-primary">Daxil ol</a>
            <a href="/user-register.html" class="btn btn-secondary">Qeydiyyat</a>
          </div>
        </div>

        <!-- Dashboard content -->
        <div id="dashboard-content" class="hidden">
          <div style="margin: 0 0 1rem 0; display: flex; justify-content: flex-end; gap: .5rem;">
            <button id="settings-btn" class="btn" aria-label="Ayarlar" title="Ayarlar" style="padding:.5rem .6rem">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .66.39 1.25 1 1.51.3.13.63.2.97.2H21a2 2 0 1 1 0 4h-.09c-.34 0-.67.07-.97.2-.61.26-1 .85-1 1.51z"></path></svg>
            </button>
            <button id="logout-btn" class="btn" aria-label="√áƒ±xƒ±≈ü" title="√áƒ±xƒ±≈ü" style="padding:.5rem .6rem">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            </button>
          </div>
          <div id="account-settings" class="analyses-section hidden" style="margin-bottom: 1.5rem;">
            <div class="analyses-header">
              <h2>Hesab ayarlarƒ±</h2>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;">
              <div class="stat-card" style="text-align:left;">
                <h3>E-po√ßtu d…ôyi≈ü</h3>
                <div class="form-group">
                  <label>Yeni e-po√ßt</label>
                  <input type="email" id="new-email" placeholder="yeni@example.com" />
                </div>
                <div class="form-group">
                  <label>M√∂vcud ≈üifr…ô</label>
                  <input type="password" id="confirm-email-password" placeholder="≈ûifr…ônizi t…ôsdiql…ôyin" />
                </div>
                <button id="save-email" class="btn btn-primary">E-po√ßtu yenil…ô</button>
                <div id="email-change-msg" class="error-message hidden" style="margin-top:.75rem"></div>
              </div>
              <div class="stat-card" style="text-align:left;">
                <h3>≈ûifr…ôni d…ôyi≈ü</h3>
                <div class="form-group">
                  <label>M√∂vcud ≈üifr…ô</label>
                  <input type="password" id="current-password" placeholder="Cari ≈üifr…ô" />
                </div>
                <div class="form-group">
                  <label>Yeni ≈üifr…ô</label>
                  <input type="password" id="new-password" placeholder="Minimum 8 simvol" />
                </div>
                <button id="save-password" class="btn btn-primary">≈ûifr…ôni yenil…ô</button>
                <div id="password-change-msg" class="error-message hidden" style="margin-top:.75rem"></div>
              </div>
              <div class="stat-card" style="text-align:left;">
                <h3>ƒ∞ki M…ôrh…ôl…ôli Doƒürulama (2FA)</h3>
                <div id="2fa-status" style="margin-bottom: 1rem;">
                  <p id="2fa-status-text" style="margin: 0; font-size: 14px; font-weight: 500;">Y√ºkl…ônir...</p>
                </div>
                <div id="2fa-actions">
                  <button id="enable-2fa-btn" class="btn btn-primary hidden">2FA Aktiv Et</button>
                  <button id="disable-2fa-btn" class="btn btn-danger hidden">2FA Deaktiv Et</button>
                </div>
                <div id="2fa-msg" class="error-message hidden" style="margin-top:.75rem"></div>
              </div>
            </div>
          </div>
          <div class="dashboard-header">
            <h1 id="welcome-title">ƒ∞stifad…ô√ßi Paneli</h1>
            <p id="welcome-subtitle">Analiz tarix√ß…ônizi g√∂r√ºn v…ô idar…ô edin</p>
          </div>

          <div class="user-stats">
            <div class="stat-card">
              <h3>üìä √úmumi Analizl…ôr</h3>
              <p id="total-analyses">-</p>
            </div>
            <div class="stat-card">
              <h3>üìÖ Bu Ay</h3>
              <p id="monthly-analyses">-</p>
            </div>
            <div class="stat-card">
              <h3>‚≠ê Orta Etibarlƒ±lƒ±q</h3>
              <p id="avg-reliability">-</p>
            </div>
            <div class="stat-card">
              <h3>üìã Plan</h3>
              <p id="user-plan">-</p>
            </div>
          </div>

          <div class="analyses-section">
            <div class="analyses-header">
              <h2>üìã Analiz Tarix√ß…ôsi</h2>
              <div>
                <button id="refresh-btn" class="btn btn-primary">üîÑ Yenil…ô</button>
                <button id="clear-btn" class="btn btn-danger">üóëÔ∏è T…ômizl…ô</button>
              </div>
            </div>

            <div id="error-message" class="error-message hidden"></div>

            <div id="analyses-list" class="analyses-list">
              <div class="loading">Analizl…ôr y√ºkl…ônir...</div>
            </div>
          </div>
        </div>
      </div>
      </div>
    </main>
  </div>

  <script src="/static/layout.js"></script>
  <script>
    class UserDashboard {
      constructor() {
        this.user = null;
        this.analyses = [];
        this.init();
      }

      async init() {
        await this.checkAuthStatus();
        if (this.user) {
          this.setupEventListeners();
          await this.loadAnalyses();
          this.updateStats();
        }
      }

      async checkAuthStatus() {
        try {
          const response = await fetch('/api/auth/me');
          if (response.ok) {
            const data = await response.json();
            if (data.user) {
              this.user = data.user;
              document.getElementById('dashboard-content').classList.remove('hidden');
              document.getElementById('auth-required').classList.add('hidden');
              
              document.getElementById('welcome-title').textContent = `Xo≈ü g…ôlmisiniz, ${this.user.username || this.user.email}!`;
              document.getElementById('user-plan').textContent = this.user.plan || 'free';
            } else {
              this.showAuthRequired();
            }
          } else {
            this.showAuthRequired();
          }
        } catch (error) {
          console.error('Auth check failed:', error);
          this.showAuthRequired();
        }
      }

      showAuthRequired() {
        document.getElementById('auth-required').classList.remove('hidden');
        document.getElementById('dashboard-content').classList.add('hidden');
      }

      setupEventListeners() {
        document.getElementById('refresh-btn').addEventListener('click', () => {
          this.loadAnalyses();
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
          if (confirm('B√ºt√ºn analiz tarix√ß…ônizi silm…ôk ist…ôdiyiniz…ô …ôminsiniz?')) {
            this.clearAnalyses();
          }
        });
      }

      async loadAnalyses() {
        try {
          const response = await fetch('/api/user/analyses');
          if (response.ok) {
            const data = await response.json();
            this.analyses = data.analyses || [];
            this.displayAnalyses();
          } else {
            this.showError('Analizl…ôr y√ºkl…ôn…ô bilm…ôdi');
          }
        } catch (error) {
          this.showError('X…ôta: ' + error.message);
        }
      }

      displayAnalyses() {
        const container = document.getElementById('analyses-list');
        
        if (this.analyses.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <h3>üì≠ Analiz yoxdur</h3>
              <p>H…ôl…ô he√ß bir analiz etm…ômisiniz. <a href="/">ƒ∞lk analizinizi edin</a></p>
            </div>
          `;
          return;
        }

        const html = this.analyses.map(analysis => {
          const reliabilityClass = analysis.reliability >= 70 ? 'reliability-high' : 
                                 analysis.reliability >= 40 ? 'reliability-medium' : 'reliability-low';
          
          const biasClass = analysis.political_bias > 1 ? 'bias-positive' : 
                           analysis.political_bias < -1 ? 'bias-negative' : 'bias-neutral';
          
          const biasText = analysis.political_bias > 1 ? 'Hakimiyy…ôt meyilli' : 
                          analysis.political_bias < -1 ? 'M√ºxalif…ôt meyilli' : 'Neytral';

          return `
            <div class="analysis-item">
              <h3>${analysis.title}</h3>
              <p><strong>üì∞ N…ô≈üriyyat:</strong> ${analysis.publication || 'Nam…ôlum'}</p>
              <p><strong>üîó Link:</strong> <a href="${analysis.url}" target="_blank" rel="noopener">${analysis.url}</a></p>
              <div class="analysis-meta">
                <div class="meta-item">
                  <span>üìä Etibarlƒ±lƒ±q:</span>
                  <span class="reliability-score ${reliabilityClass}">${analysis.reliability}/100</span>
                </div>
                <div class="meta-item">
                  <span>‚öñÔ∏è Siyasi meyl:</span>
                  <span class="bias-score ${biasClass}">${analysis.political_bias} (${biasText})</span>
                </div>
                <div class="meta-item">
                  <span>üìÖ T…ôhlil edilib:</span>
                  <span>${new Date(analysis.analyzed_at).toLocaleDateString('az-AZ')}</span>
                </div>
                ${analysis.published_at ? `
                  <div class="meta-item">
                    <span>üì∞ N…ô≈ür tarixi:</span>
                    <span>${new Date(analysis.published_at).toLocaleDateString('az-AZ')}</span>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = html;
      }

      updateStats() {
        document.getElementById('total-analyses').textContent = this.analyses.length;
        
        // Calculate monthly analyses
        const now = new Date();
        const thisMonth = now.getMonth();
        const thisYear = now.getFullYear();
        const monthlyAnalyses = this.analyses.filter(analysis => {
          const analysisDate = new Date(analysis.analyzed_at);
          return analysisDate.getMonth() === thisMonth && analysisDate.getFullYear() === thisYear;
        }).length;
        document.getElementById('monthly-analyses').textContent = monthlyAnalyses;

        // Calculate average reliability
        if (this.analyses.length > 0) {
          const avgReliability = Math.round(
            this.analyses.reduce((sum, analysis) => sum + analysis.reliability, 0) / this.analyses.length
          );
          document.getElementById('avg-reliability').textContent = avgReliability + '/100';
        } else {
          document.getElementById('avg-reliability').textContent = '-';
        }
      }

      async clearAnalyses() {
        try {
          const response = await fetch('/api/user/analyses', {
            method: 'DELETE'
          });
          
          if (response.ok) {
            this.analyses = [];
            this.displayAnalyses();
            this.updateStats();
            this.showSuccess('Analiz tarix√ß…ôsi t…ômizl…ôndi');
          } else {
            this.showError('T…ômizl…ôm…ô uƒüursuz oldu');
          }
        } catch (error) {
          this.showError('X…ôta: ' + error.message);
        }
      }

      showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        setTimeout(() => {
          errorDiv.classList.add('hidden');
        }, 5000);
      }

      showSuccess(message) {
        // Create a temporary success message
        const successDiv = document.createElement('div');
        successDiv.className = 'error-message';
        successDiv.style.background = '#f0fdf4';
        successDiv.style.color = '#16a34a';
        successDiv.style.borderColor = '#bbf7d0';
        successDiv.textContent = message;
        
        const container = document.querySelector('.analyses-section');
        container.insertBefore(successDiv, container.firstChild);
        
        setTimeout(() => {
          successDiv.remove();
        }, 3000);
      }
    }

    // Initialize dashboard when page loads
    new UserDashboard();

    // Global handler for logout button (event delegation)
    document.addEventListener('click', async (e) => {
      const target = e.target;
      if (target && target.id === 'logout-btn') {
        try {
          await fetch('/api/auth/logout', { method: 'POST' });
        } catch {}
        window.location.href = '/user-login.html';
      }
      if (target && target.id === 'settings-btn') {
        const panel = document.getElementById('account-settings');
        if (panel) {
          if (panel.classList.contains('hidden')) panel.classList.remove('hidden');
          else panel.classList.add('hidden');
        }
      }
      if (target && target.id === 'save-email') {
        const msg = document.getElementById('email-change-msg');
        if (msg) msg.classList.add('hidden');
        const newEmail = (document.getElementById('new-email') || {}).value?.trim()?.toLowerCase() || '';
        const pwd = (document.getElementById('confirm-email-password') || {}).value || '';
        if (!newEmail || !pwd) {
          if (msg) { msg.textContent = 'Yeni e-po√ßt v…ô m√∂vcud ≈üifr…ô t…ôl…ôb olunur'; msg.classList.remove('hidden'); }
          return;
        }
        try {
          const r = await fetch('/api/account/change-email', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ newEmail, currentPassword: pwd }) });
          const data = await r.json().catch(() => ({}));
          if (r.ok) {
            if (msg) { msg.style.background = '#f0fdf4'; msg.style.color = '#16a34a'; msg.style.borderColor = '#bbf7d0'; msg.textContent = 'E-po√ßt yenil…ôndi'; msg.classList.remove('hidden'); }
            const ne = document.getElementById('new-email'); if (ne) ne.value='';
            const cp = document.getElementById('confirm-email-password'); if (cp) cp.value='';
            if (data.user && data.user.email) {
              const wt = document.getElementById('welcome-title');
              if (wt) wt.textContent = `Xo≈ü g…ôlmisiniz, ${data.user.username || data.user.email}!`;
            }
          } else {
            if (msg) { msg.textContent = data.message || 'Yenil…ôm…ô alƒ±nmadƒ±'; msg.classList.remove('hidden'); }
          }
        } catch { if (msg) { msg.textContent = 'X…ôta ba≈ü verdi'; msg.classList.remove('hidden'); } }
      }
      if (target && target.id === 'save-password') {
        const msg = document.getElementById('password-change-msg');
        if (msg) msg.classList.add('hidden');
        const currentPassword = (document.getElementById('current-password') || {}).value || '';
        const newPassword = (document.getElementById('new-password') || {}).value || '';
        if (!currentPassword || !newPassword) {
          if (msg) { msg.textContent = 'Cari v…ô yeni ≈üifr…ô t…ôl…ôb olunur'; msg.classList.remove('hidden'); }
          return;
        }
        try {
          const r = await fetch('/api/account/change-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ currentPassword, newPassword }) });
          const data = await r.json().catch(() => ({}));
          if (r.ok) {
            if (msg) { msg.style.background = '#f0fdf4'; msg.style.color = '#16a34a'; msg.style.borderColor = '#bbf7d0'; msg.textContent = '≈ûifr…ô yenil…ôndi'; msg.classList.remove('hidden'); }
            const cp = document.getElementById('current-password'); if (cp) cp.value='';
            const np = document.getElementById('new-password'); if (np) np.value='';
          } else {
            if (msg) { msg.textContent = data.message || 'Yenil…ôm…ô alƒ±nmadƒ±'; msg.classList.remove('hidden'); }
          }
        } catch { if (msg) { msg.textContent = 'X…ôta ba≈ü verdi'; msg.classList.remove('hidden'); } }
      }
    });

    // Hide plan card for non-developer users
    (async () => {
      try {
        const resp = await fetch('/api/auth/me');
        if (!resp.ok) return;
        const data = await resp.json();
        const user = data && data.user ? data.user : null;
        if (!user) return;
        const isBasicUser = (user.role === 'user') && (!user.plan || user.plan === 'free');
        if (isBasicUser) {
          const planEl = document.getElementById('user-plan');
          if (planEl && planEl.closest) {
            const card = planEl.closest('.stat-card');
            if (card) card.style.display = 'none';
          }
        }
      } catch {}
    })();

    // 2FA Management
    async function load2FAStatus() {
      try {
        const response = await fetch('/api/auth/me');
        if (response.ok) {
          const data = await response.json();
          const user = data.user;
          const statusText = document.getElementById('2fa-status-text');
          const enableBtn = document.getElementById('enable-2fa-btn');
          const disableBtn = document.getElementById('disable-2fa-btn');
          
          if (user.twoFactorEnabled) {
            statusText.textContent = '‚úÖ 2FA aktivdir';
            statusText.style.color = '#16a34a';
            statusText.style.fontSize = '14px';
            enableBtn.classList.add('hidden');
            disableBtn.classList.remove('hidden');
          } else {
            statusText.textContent = '2FA deaktivdir';
            statusText.style.color = '#6b7280';
            statusText.style.fontSize = '14px';
            enableBtn.classList.remove('hidden');
            disableBtn.classList.add('hidden');
          }
        }
      } catch (error) {
        console.error('2FA status load error:', error);
        document.getElementById('2fa-status-text').textContent = 'X…ôta: Status y√ºkl…ôn…ô bilm…ôdi';
      }
    }

    // Enable 2FA
    document.getElementById('enable-2fa-btn').addEventListener('click', () => {
      window.location.href = '/2fa-setup.html';
    });

    // Disable 2FA
    document.getElementById('disable-2fa-btn').addEventListener('click', async () => {
      const password = prompt('2FA-nƒ± deaktiv etm…ôk √º√ß√ºn ≈üifr…ônizi daxil edin:');
      if (!password) return;

      const msg = document.getElementById('2fa-msg');
      msg.classList.add('hidden');

      try {
        const response = await fetch('/api/auth/2fa/disable', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await response.json();

        if (response.ok) {
          msg.style.background = '#f0fdf4';
          msg.style.color = '#16a34a';
          msg.style.borderColor = '#bbf7d0';
          msg.textContent = '2FA uƒüurla deaktiv edildi';
          msg.classList.remove('hidden');
          load2FAStatus(); // Reload status
        } else {
          msg.textContent = data.message || '2FA deaktiv edil…ô bilm…ôdi';
          msg.classList.remove('hidden');
        }
      } catch (error) {
        msg.textContent = 'X…ôta: ' + error.message;
        msg.classList.remove('hidden');
      }
    });

    // Load 2FA status on page load
    load2FAStatus();
    
    // Refresh 2FA status when returning from setup page
    if (window.location.search.includes('2fa=setup-complete')) {
      setTimeout(() => {
        load2FAStatus();
        // Remove the parameter from URL
        const url = new URL(window.location);
        url.searchParams.delete('2fa');
        window.history.replaceState({}, '', url);
      }, 1000);
    }
  </script>
</body>
</html>
