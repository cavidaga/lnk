<!DOCTYPE html>
<html lang="az" class="no-js">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Analizl…ôr - LNK</title>
  <meta name="description" content="M√ºxt…ôlif saytlardan analiz edilmi≈ü m…ôqal…ôl…ôrin siyahƒ±sƒ±">
  <meta name="theme-color" content="#0c0d12">
  <meta name="color-scheme" content="light dark" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

  <!-- Google Fonts: Poppins -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Canonical & Open Graph -->
  <link rel="canonical" href="https://lnk.az/analyses-by-domain" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="LNK.az" />
  <meta property="og:title" content="Analizl…ôr - LNK" />
  <meta property="og:description" content="M√ºxt…ôlif saytlardan analiz edilmi≈ü m…ôqal…ôl…ôrin siyahƒ±sƒ±" />
  <meta property="og:url" content="https://lnk.az/analyses-by-domain" />
  <meta property="og:image" content="https://lnk.az/static/og-cover.png" />
  <meta property="og:locale" content="az_AZ" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Analizl…ôr - LNK" />
  <meta name="twitter:description" content="M√ºxt…ôlif saytlardan analiz edilmi≈ü m…ôqal…ôl…ôrin siyahƒ±sƒ±" />
  <meta name="twitter:image" content="https://lnk.az/static/og-cover.png" />

  <!-- Icons -->
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/static/favicon.ico">
  <link rel="icon" href="/static/favicon-light.svg" media="(prefers-color-scheme: light)">
  <link rel="icon" href="/static/favicon-dark.svg"  media="(prefers-color-scheme: dark)">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
  <link rel="mask-icon" href="/static/safari-pinned-tab.svg" color="#e10600">

  <link rel="stylesheet" href="/static/styles.css">
  <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>
  <div class="wrap">
    <div id="site-header"></div>
    
    <main class="main">
      <div class="container">
        <div class="page-header">
          <h1 id="page-title">üì∞ Analizl…ôr</h1>
          <p class="page-description" id="page-description">
            Y√ºkl…ônir...
          </p>
        </div>

        <div id="loading" class="loading">
          <div class="spinner"></div>
          <p>Analizl…ôr y√ºkl…ônir...</p>
        </div>
        
        <div id="error-message" class="error-message hidden">
          <p>Analizl…ôr y√ºkl…ôn…ô bilm…ôdi. Z…ôhm…ôt olmasa s…ôhif…ôni yenil…ôyin.</p>
        </div>
        
        <div id="analyses-content" class="analyses-content hidden">
          <div class="analyses-stats">
            <div class="stat-item">
              <span class="stat-label">G√∂st…ôril…ôn analiz sayƒ±:</span>
              <span id="shown-analyses" class="stat-value">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Qeyd:</span>
              <span class="stat-value" style="font-size: 0.9rem; color: #666;">Analizl…ôr indi h…ômi≈ü…ôlik saxlanƒ±lƒ±r. K√∂hn…ô analizl…ôri yenil…ôm…ôk √º√ß√ºn "Yenil…ô" d√ºym…ôsini basƒ±n.</span>
            </div>
            <div class="stat-item" id="missing-analyses" style="display: none;">
              <span class="stat-label">Silinmi≈ü analizl…ôr:</span>
              <span id="missing-count" class="stat-value" style="color: #dc3545;">-</span>
            </div>
          </div>
          
          <div id="analyses-list" class="analyses-list">
            <!-- Analyses will be populated here -->
          </div>
          
          <div id="load-more-container" class="load-more-container hidden">
            <button id="load-more-btn" class="btn btn-primary">Daha √ßox y√ºkl…ô</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/static/layout.js"></script>
  <script>
    class DomainAnalyses {
      constructor() {
        this.domain = '';
        this.analyses = [];
        this.currentOffset = 0;
        this.limit = 20;
        this.total = 0;
        this.loading = false;
        this.init();
      }

      async init() {
        // Get domain from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        this.domain = urlParams.get('domain') || '';
        
        if (!this.domain) {
          this.showError('Domain parametri t…ôl…ôb olunur');
          return;
        }

        this.updatePageTitle();
        await this.loadAnalyses();
      }

      updatePageTitle() {
        document.getElementById('page-title').textContent = `üì∞ ${this.domain} analizl…ôri`;
        document.getElementById('page-description').textContent = 
          `${this.domain} saytƒ±ndan analiz edilmi≈ü m…ôqal…ôl…ôrin siyahƒ±sƒ±`;
      }

      async loadAnalyses(append = false) {
        if (this.loading) return;
        
        this.loading = true;
        this.showLoading();
        this.hideError();

        try {
          const params = new URLSearchParams({
            domain: this.domain,
            limit: this.limit,
            offset: this.currentOffset
          });

          const response = await fetch(`/api/analyses-by-domain?${params}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          
          if (append) {
            this.analyses = [...this.analyses, ...data.analyses];
          } else {
            this.analyses = data.analyses;
          }
          
          this.total = data.total;
          this.currentOffset += data.analyses.length;
          
          this.updateStats(data);
          this.renderAnalyses();
          this.hideLoading();
          this.showContent();

          // Show/hide load more button
          if (data.hasMore) {
            document.getElementById('load-more-container').classList.remove('hidden');
          } else {
            document.getElementById('load-more-container').classList.add('hidden');
          }

        } catch (error) {
          console.error('Error loading analyses:', error);
          this.hideLoading();
          this.showError();
        } finally {
          this.loading = false;
        }
      }

      updateStats(data) {
        document.getElementById('shown-analyses').textContent = this.analyses.length.toLocaleString('az-AZ');
        
        // Show missing analyses count if any
        if (data.missing_count && data.missing_count > 0) {
          document.getElementById('missing-count').textContent = data.missing_count.toLocaleString('az-AZ');
          document.getElementById('missing-analyses').style.display = 'block';
        } else {
          document.getElementById('missing-analyses').style.display = 'none';
        }
      }

      renderAnalyses() {
        const container = document.getElementById('analyses-list');
        
        if (this.analyses.length === 0) {
          container.innerHTML = '<div class="no-results">Bu saytdan h…ôl…ô analiz edilmi≈ü m…ôqal…ô yoxdur.</div>';
          return;
        }

        const html = this.analyses.map((analysis, index) => {
          const reliabilityClass = this.getReliabilityClass(analysis.reliability);
          const biasClass = this.getBiasClass(analysis.political_bias);
          const biasText = this.formatBias(analysis.political_bias);
          const isOld = analysis.is_old || analysis.needs_refresh;
          
          return `
            <div class="analysis-item ${isOld ? 'analysis-old' : ''}">
              <div class="analysis-header">
                <h3 class="analysis-title">
                  <a href="/analysis/${analysis.hash}" target="_blank" rel="noopener">
                    ${this.escapeHtml(analysis.title)}
                  </a>
                  ${isOld ? '<span class="old-badge">K√∂hn…ô</span>' : ''}
                </h3>
                <div class="analysis-scores">
                  <div class="score-item ${reliabilityClass}">
                    <span class="score-label">Etibarlƒ±lƒ±q</span>
                    <span class="score-value">${Math.round(analysis.reliability)}/100</span>
                  </div>
                  <div class="score-item ${biasClass}">
                    <span class="score-label">Siyasi meyl</span>
                    <span class="score-value">${biasText}</span>
                  </div>
                </div>
              </div>
              <div class="analysis-meta">
                <span class="analysis-url">
                  <a href="${analysis.url}" target="_blank" rel="noopener">${this.escapeHtml(analysis.url)}</a>
                </span>
                <span class="analysis-date">${this.formatDate(analysis.analyzed_at)}</span>
                ${isOld ? `
                  <button class="btn btn-sm btn-outline refresh-analysis-btn" data-url="${this.escapeHtml(analysis.url)}">
                    üîÑ Yenid…ôn analiz et
                  </button>
                ` : ''}
              </div>
              ${analysis.human_summary ? `
                <div class="analysis-summary">
                  <p>${this.escapeHtml(analysis.human_summary)}</p>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');

        container.innerHTML = html;
        
        // Add event listeners for refresh analysis buttons
        this.setupRefreshButtons();
      }
      
      setupRefreshButtons() {
        const refreshButtons = document.querySelectorAll('.refresh-analysis-btn');
        refreshButtons.forEach(button => {
          button.addEventListener('click', (e) => {
            e.preventDefault();
            const url = button.getAttribute('data-url');
            this.refreshAnalysis(url, button);
          });
        });
      }
      
      async refreshAnalysis(url, button) {
        if (button.disabled) return;
        
        button.disabled = true;
        button.textContent = 'üóëÔ∏è Silinir...';
        
        try {
          // First, delete the old analysis
          const deleteResponse = await fetch('/api/delete-analysis', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ url: url })
          });
          
          if (!deleteResponse.ok) {
            throw new Error('Failed to delete old analysis');
          }
          
          button.textContent = 'üîÑ Yenid…ôn analiz edilir...';
          
          // Then redirect to the analysis page with the URL
          window.open(`/?url=${encodeURIComponent(url)}`, '_blank');
          
          // Remove the analysis item from the UI
          const analysisItem = button.closest('.analysis-item');
          if (analysisItem) {
            analysisItem.style.opacity = '0.5';
            analysisItem.style.textDecoration = 'line-through';
            analysisItem.querySelector('.refresh-analysis-btn').textContent = '‚úÖ Silindi';
          }
          
          // Reset button after a delay
          setTimeout(() => {
            button.disabled = false;
            button.textContent = 'üîÑ Yenid…ôn analiz et';
          }, 5000);
        } catch (error) {
          console.error('Error refreshing analysis:', error);
          button.disabled = false;
          button.textContent = '‚ùå X…ôta';
        }
      }

      getReliabilityClass(score) {
        if (score >= 80) return 'reliability-excellent';
        if (score >= 60) return 'reliability-good';
        if (score >= 40) return 'reliability-fair';
        if (score >= 20) return 'reliability-poor';
        return 'reliability-very-poor';
      }

      getBiasClass(score) {
        if (Math.abs(score) >= 3) return 'bias-strong';
        if (Math.abs(score) >= 1) return 'bias-moderate';
        return 'bias-neutral';
      }

      formatBias(score) {
        if (score > 0) return `+${score.toFixed(1)}`;
        return score.toFixed(1);
      }

      formatDate(dateString) {
        if (!dateString) return '‚Äî';
        const date = new Date(dateString);
        return date.toLocaleDateString('az-AZ');
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      showLoading() {
        document.getElementById('loading').classList.remove('hidden');
      }

      hideLoading() {
        document.getElementById('loading').classList.add('hidden');
      }

      showError(message = 'Analizl…ôr y√ºkl…ôn…ô bilm…ôdi') {
        const errorEl = document.getElementById('error-message');
        errorEl.querySelector('p').textContent = message;
        errorEl.classList.remove('hidden');
      }

      hideError() {
        document.getElementById('error-message').classList.add('hidden');
      }

      showContent() {
        document.getElementById('analyses-content').classList.remove('hidden');
      }

      hideContent() {
        document.getElementById('analyses-content').classList.add('hidden');
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new DomainAnalyses();
      
      // Load more button
      document.getElementById('load-more-btn').addEventListener('click', () => {
        const domainAnalyses = window.domainAnalysesInstance;
        if (domainAnalyses) {
          domainAnalyses.loadAnalyses(true);
        }
      });
    });

    // Store instance globally for load more button
    window.domainAnalysesInstance = null;
    document.addEventListener('DOMContentLoaded', () => {
      window.domainAnalysesInstance = new DomainAnalyses();
    });
  </script>
</body>
</html>
